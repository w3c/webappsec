<!DOCTYPE html>
<html lang="en" dir="ltr" typeof="bibo:Document " about="" property="dcterms:language" content="en">
<head>
  <meta charset="utf-8">
  <title>Subresource Integrity</title>
  
  
<style>/*****************************************************************
 * ReSpec 3 CSS
 * Robin Berjon - http://berjon.com/
 *****************************************************************/

/* --- INLINES --- */
em.rfc2119 { 
    text-transform:     lowercase;
    font-variant:       small-caps;
    font-style:         normal;
    color:              #900;
}

h1 acronym, h2 acronym, h3 acronym, h4 acronym, h5 acronym, h6 acronym, a acronym,
h1 abbr, h2 abbr, h3 abbr, h4 abbr, h5 abbr, h6 abbr, a abbr {
    border: none;
}

dfn {
    font-weight:    bold;
}

a.internalDFN {
    color:  inherit;
    border-bottom:  1px solid #99c;
    text-decoration:    none;
}

a.externalDFN {
    color:  inherit;
    border-bottom:  1px dotted #ccc;
    text-decoration:    none;
}

a.bibref {
    text-decoration:    none;
}

cite .bibref {
    font-style: normal;
}

code {
    color:  #ff4500;
}

/* --- TOC --- */
.toc a, .tof a {
    text-decoration:    none;
}

a .secno, a .figno {
    color:  #000;
}

ul.tof, ol.tof {
    list-style: none outside none;
}

.caption {
    margin-top: 0.5em;
    font-style:   italic;
}

/* --- TABLE --- */
table.simple {
    border-spacing: 0;
    border-collapse:    collapse;
    border-bottom:  3px solid #005a9c;
}

.simple th {
    background: #005a9c;
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
}

.simple th[scope="row"] {
    background: inherit;
    color:  inherit;
    border-top: 1px solid #ddd;
}

.simple td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
}

.simple tr:nth-child(even) {
    background: #f0f6ff;
}

/* --- DL --- */
.section dd > p:first-child {
    margin-top: 0;
}

.section dd > p:last-child {
    margin-bottom: 0;
}

.section dd {
    margin-bottom:  1em;
}

.section dl.attrs dd, .section dl.eldef dd {
    margin-bottom:  0;
}

@media print {
    .removeOnSave {
        display: none;
    }
}
</style><style>/* --- ISSUES/NOTES --- */
div.issue-title, div.note-title {
    padding-right:  1em;
    min-width: 7.5em;
    color: #b9ab2d;
}
div.issue-title { color: #e05252; }
div.note-title { color: #2b2; }
div.issue-title span, div.note-title span {
    text-transform: uppercase;
}
div.note, div.issue {
    margin-top: 1em;
    margin-bottom: 1em;
}
.note > p:first-child, .issue > p:first-child { margin-top: 0 }
.issue, .note {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
}
div.issue, div.note {
    padding: 1em 1.2em 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
span.note, span.issue { padding: .1em .5em .15em; }

.issue {
    border-color: #e05252;
    background: #fbe9e9;
}
.note {
    border-color: #52e052;
    background: #e9fbe9;
}


</style><style>/* --- WEB IDL --- */
pre.idl {
    border-top: 1px solid #90b8de;
    border-bottom: 1px solid #90b8de;
    padding:    1em;
    line-height:    120%;
}

pre.idl::before {
    content:    "WebIDL";
    display:    block;
    width:      150px;
    background: #90b8de;
    color:  #fff;
    font-family:    initial;
    padding:    3px;
    font-weight:    bold;
    margin: -1em 0 1em -1em;
}

.idlType {
    color:  #ff4500;
    font-weight:    bold;
    text-decoration:    none;
}

/*.idlModule*/
/*.idlModuleID*/
/*.idlInterface*/
.idlInterfaceID, .idlDictionaryID, .idlCallbackID, .idlEnumID {
    font-weight:    bold;
    color:  #005a9c;
}
a.idlEnumItem {
    color:  #000;
    border-bottom:  1px dotted #ccc;
    text-decoration: none;
}

.idlSuperclass {
    font-style: italic;
    color:  #005a9c;
}

/*.idlAttribute*/
.idlAttrType, .idlFieldType, .idlMemberType {
    color:  #005a9c;
}
.idlAttrName, .idlFieldName, .idlMemberName {
    color:  #ff4500;
}
.idlAttrName a, .idlFieldName a, .idlMemberName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlMethod*/
.idlMethType, .idlCallbackType {
    color:  #005a9c;
}
.idlMethName {
    color:  #ff4500;
}
.idlMethName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlCtor*/
.idlCtorName {
    color:  #ff4500;
}
.idlCtorName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlParam*/
.idlParamType {
    color:  #005a9c;
}
.idlParamName, .idlDefaultValue {
    font-style: italic;
}

.extAttr {
    color:  #666;
}

/*.idlSectionComment*/
.idlSectionComment {
    color: gray;
}

/*.idlConst*/
.idlConstType {
    color:  #005a9c;
}
.idlConstName {
    color:  #ff4500;
}
.idlConstName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlException*/
.idlExceptionID {
    font-weight:    bold;
    color:  #c00;
}

.idlTypedefID, .idlTypedefType {
    color:  #005a9c;
}

.idlRaises, .idlRaises a.idlType, .idlRaises a.idlType code, .excName a, .excName a code {
    color:  #c00;
    font-weight:    normal;
}

.excName a {
    font-family:    monospace;
}

.idlRaises a.idlType, .excName a.idlType {
    border-bottom:  1px dotted #c00;
}

.excGetSetTrue, .excGetSetFalse, .prmNullTrue, .prmNullFalse, .prmOptTrue, .prmOptFalse {
    width:  45px;
    text-align: center;
}
.excGetSetTrue, .prmNullTrue, .prmOptTrue { color:  #0c0; }
.excGetSetFalse, .prmNullFalse, .prmOptFalse { color:  #c00; }

.idlImplements a {
    font-weight:    bold;
}

dl.attributes, dl.methods, dl.constants, dl.constructors, dl.fields, dl.dictionary-members {
    margin-left:    2em;
}

.attributes dt, .methods dt, .constants dt, .constructors dt, .fields dt, .dictionary-members dt {
    font-weight:    normal;
}

.attributes dt code, .methods dt code, .constants dt code, .constructors dt code, .fields dt code, .dictionary-members dt code {
    font-weight:    bold;
    color:  #000;
    font-family:    monospace;
}

.attributes dt code, .fields dt code, .dictionary-members dt code {
    background:  #ffffd2;
}

.attributes dt .idlAttrType code, .fields dt .idlFieldType code, .dictionary-members dt .idlMemberType code {
    color:  #005a9c;
    background:  transparent;
    font-family:    inherit;
    font-weight:    normal;
    font-style: italic;
}

.methods dt code {
    background:  #d9e6f8;
}

.constants dt code {
    background:  #ddffd2;
}

.constructors dt code {
    background:  #cfc;
}

.attributes dd, .methods dd, .constants dd, .constructors dd, .fields dd, .dictionary-members dd {
    margin-bottom:  1em;
}

table.parameters, table.exceptions {
    border-spacing: 0;
    border-collapse:    collapse;
    margin: 0.5em 0;
    width:  100%;
}
table.parameters { border-bottom:  1px solid #90b8de; }
table.exceptions { border-bottom:  1px solid #deb890; }

.parameters th, .exceptions th {
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
    font-family:    initial;
    font-weight:    normal;
    text-shadow:    #666 1px 1px 0;
}
.parameters th { background: #90b8de; }
.exceptions th { background: #deb890; }

.parameters td, .exceptions td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
    vertical-align: top;
}

.parameters tr:first-child td, .exceptions tr:first-child td {
    border-top: none;
}

.parameters td.prmName, .exceptions td.excName, .exceptions td.excCodeName {
    width:  100px;
}

.parameters td.prmType {
    width:  120px;
}

table.exceptions table {
    border-spacing: 0;
    border-collapse:    collapse;
    width:  100%;
}
</style><link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/W3C-ED"><!--[if lt IE 9]><script src='https://www.w3.org/2008/site/js/html5shiv.js'></script><![endif]--></head>
<body class="h-entry" role="document" id="respecDocument"><div class="head" role="contentinfo" id="respecHeader">
  <p>
    
      <a href="http://www.w3.org/"><img width="72" height="48" src="https://www.w3.org/Icons/w3c_home" alt="W3C"></a>
    
  </p>
  <h1 class="title p-name" id="title" property="dcterms:title">Subresource Integrity</h1>
  
  <h2 property="dcterms:issued" datatype="xsd:dateTime" content="2014-03-12T14:32:12.000Z" id="w3c-editor-s-draft-12-march-2014"><abbr title="World Wide Web Consortium">W3C</abbr> Editor's Draft <time class="dt-published" datetime="2014-03-12">12 March 2014</time></h2>
  <dl>
    
      <dt>This version:</dt>
      <dd><a class="u-url" href="http://w3c.github.io/webappsec/specs/subresourceintegrity/">http://w3c.github.io/webappsec/specs/subresourceintegrity/</a></dd>
      <dt>Latest published version:</dt>
      <dd><a href="http://www.w3.org/TR/subresourceintegrity/">http://www.w3.org/TR/subint/</a></dd>
    
    
      <dt>Latest editor's draft:</dt>
      <dd><a href="http://w3c.github.io/webappsec/specs/subresourceintegrity/">http://w3c.github.io/webappsec/specs/subresourceintegrity/</a></dd>
    
    
    
    
    
      
    
    
    
    <dt>Editors:</dt>
    <dd class="p-author h-card vcard" rel="bibo:editor" inlist=""><span typeof="foaf:Person"><a class="u-url url p-name fn" rel="foaf:homepage" property="foaf:name" content="Frederik Braun" href="mailto:fbraun@mozilla.com">Frederik Braun</a>, <a rel="foaf:workplaceHomepage" class="p-org org h-org h-card" href="https://www.mozilla.com/">Mozilla Corporation</a></span>
</dd>
<dd class="p-author h-card vcard" rel="bibo:editor" inlist=""><span typeof="foaf:Person"><a class="u-url url p-name fn" rel="foaf:homepage" property="foaf:name" content="Devdatta Akhawe" href="mailto:dev.akhawe@gmail.com">Devdatta Akhawe</a>, UC Berkeley</span>
</dd>
<dd class="p-author h-card vcard" rel="bibo:editor" inlist=""><span typeof="foaf:Person"><a class="u-url url p-name fn" rel="foaf:homepage" property="foaf:name" content="Joel Weinberger" href="mailto:jww@google.com">Joel Weinberger</a>, <a rel="foaf:workplaceHomepage" class="p-org org h-org h-card" href="https://google.com/">Google, Inc.</a></span>
</dd>
<dd class="p-author h-card vcard" rel="bibo:editor" inlist=""><span typeof="foaf:Person"><a class="u-url url p-name fn" rel="foaf:homepage" property="foaf:name" content="Mike West" href="mailto:mkwst@google.com">Mike West</a>, <a rel="foaf:workplaceHomepage" class="p-org org h-org h-card" href="https://google.com/">Google, Inc.</a></span>
</dd>

    
    
  </dl>
  
  
  
  
    
      <p class="copyright">
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> ©
        2013-2014
        
        <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup>
        (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>,
        <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>,
        <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>), 
        
        All Rights Reserved.
        
        <abbr title="World Wide Web Consortium">W3C</abbr> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>,
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and
        
          <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a>
        
        rules apply.
      </p>
    
  
  <hr>
</div>
<section id="abstract" class="introductory" property="dcterms:abstract" datatype="" typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter"><h2 aria-level="1" role="heading" id="h2_abstract">Abstract</h2>
  <p>This specification defines a mechanism by which user agents may verify that
a fetched resource has been delivered without unexpected manipulation.</p>
</section><section id="sotd" class="introductory" typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter"><h2 aria-level="1" role="heading" id="h2_sotd">Status of This Document</h2>
  
    
      
        <p>
          <em>This section describes the status of this document at the time of its publication.
          Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the
          latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at
          http://www.w3.org/TR/.</em>
        </p>
        
  <p>A list of changes to this document may be found at
<a href="https://github.com/w3c/webappsec">https://github.com/w3c/webappsec</a>.</p>

        <p>
          This document was published by the <a href="http://www.w3.org/2011/webappsec/">Web Application Security Working Group</a> as an Editor's Draft.
          
          
            If you wish to make comments regarding this document, please send them to 
            <a href="mailto:public-webappsec@w3.org?subject=[Integrity]">public-webappsec@w3.org</a> 
            (<a href="mailto:public-webappsec-request@w3.org?subject=subscribe">subscribe</a>,
            <a href="http://lists.w3.org/Archives/Public/public-webappsec/">archives</a>)
              with <code>[Integrity]</code> at the start of your email's subject.
          
          
          
          
            All comments are welcome.
          
        </p>
        
        
          <p>
            Publication as an Editor's Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr>
            Membership. This is a draft document and may be updated, replaced or obsoleted by other
            documents at any time. It is inappropriate to cite this document as other than work in
            progress.
          </p>
        
        
        
        <p>
          
            This document was produced by a group operating under the 
            <a id="sotd_patent" about="" rel="w3p:patentRules" href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent
            Policy</a>.
          
          
          
            
              <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/49309/status" rel="disclosure">public list of any patent
              disclosures</a> 
            
            made in connection with the deliverables of the group; that page also includes
            instructions for disclosing a patent. An individual who has actual knowledge of a patent
            which the individual believes contains
            <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
            Claim(s)</a> must disclose the information in accordance with
            <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
            6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.
          
          
        </p>
        
      
    
  
</section><section id="toc"><h2 class="introductory" aria-level="1" role="heading" id="h2_toc">Table of Contents</h2><ul class="toc" role="directory" id="respecContents"><li class="tocline"><a href="#introduction-1" class="tocxref"><span class="secno">1. </span>Introduction</a><ul class="toc"><li class="tocline"><a href="#goals-1" class="tocxref"><span class="secno">1.1 </span>Goals</a></li><li class="tocline"><a href="#use-cases-examples" class="tocxref"><span class="secno">1.2 </span>Use Cases/Examples</a><ul class="toc"><li class="tocline"><a href="#resource-integrity-1" class="tocxref"><span class="secno">1.2.1 </span>Resource Integrity</a></li><li class="tocline"><a href="#downloads-1" class="tocxref"><span class="secno">1.2.2 </span>Downloads</a></li><li class="tocline"><a href="#fallback-1" class="tocxref"><span class="secno">1.2.3 </span>Fallback</a></li></ul></li></ul></li><li class="tocline"><a href="#conformance" class="tocxref"><span class="secno">2. </span>Conformance</a><ul class="toc"><li class="tocline"><a href="#key-concepts-and-terminology-1" class="tocxref"><span class="secno">2.1 </span>Key Concepts and Terminology</a></li></ul></li><li class="tocline"><a href="#framework-1" class="tocxref"><span class="secno">3. </span>Framework</a><ul class="toc"><li class="tocline"><a href="#integrity-metadata-1" class="tocxref"><span class="secno">3.1 </span>Integrity metadata</a></li><li class="tocline"><a href="#cryptographic-hash-functions-1" class="tocxref"><span class="secno">3.2 </span>Cryptographic hash functions</a></li><li class="tocline"><a href="#resource-verification-algorithms-1" class="tocxref"><span class="secno">3.3 </span>Resource verification algorithms</a><ul class="toc"><li class="tocline"><a href="#apply-algorithm-to-resource" class="tocxref"><span class="secno">3.3.1 </span>Apply <var>algorithm</var> to <var>resource</var></a></li><li class="tocline"><a href="#is-resource-eligible-for-integrity-validation" class="tocxref"><span class="secno">3.3.2 </span>Is <var>resource</var> eligible for integrity validation</a></li><li class="tocline"><a href="#does-resource-match-metadata" class="tocxref"><span class="secno">3.3.3 </span>Does <var>resource</var> match <var>metadata</var>?</a></li></ul></li><li class="tocline"><a href="#modifications-to-fetch-1" class="tocxref"><span class="secno">3.4 </span>Modifications to Fetch</a></li><li class="tocline"><a href="#verification-of-html-document-subresources-1" class="tocxref"><span class="secno">3.5 </span>Verification of HTML document subresources</a><ul class="toc"><li class="tocline"><a href="#the-integrity-attribute-2" class="tocxref"><span class="secno">3.5.1 </span>The <code>integrity</code> attribute</a></li><li class="tocline"><a href="#the-noncanonical-src-attribute-todo-1" class="tocxref"><span class="secno">3.5.2 </span>The <code>noncanonical-src</code> attribute (TODO)</a></li><li class="tocline"><a href="#element-interface-extensions-1" class="tocxref"><span class="secno">3.5.3 </span>Element interface extensions</a><ul class="toc"><li class="tocline"><a href="#htmlanchorelement-1" class="tocxref"><span class="secno">3.5.3.1 </span>HTMLAnchorElement</a><ul class="toc"><li class="tocline"><a href="#attributes" class="tocxref"><span class="secno">3.5.3.1.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#htmlembedelement-1" class="tocxref"><span class="secno">3.5.3.2 </span>HTMLEmbedElement</a><ul class="toc"><li class="tocline"><a href="#attributes-1" class="tocxref"><span class="secno">3.5.3.2.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#htmliframeelement-1" class="tocxref"><span class="secno">3.5.3.3 </span>HTMLIFrameElement</a><ul class="toc"><li class="tocline"><a href="#attributes-2" class="tocxref"><span class="secno">3.5.3.3.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#htmlimageelement-1" class="tocxref"><span class="secno">3.5.3.4 </span>HTMLImageElement</a><ul class="toc"><li class="tocline"><a href="#attributes-3" class="tocxref"><span class="secno">3.5.3.4.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#htmllinkelement-1" class="tocxref"><span class="secno">3.5.3.5 </span>HTMLLinkElement</a><ul class="toc"><li class="tocline"><a href="#attributes-4" class="tocxref"><span class="secno">3.5.3.5.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#htmlmediaelement-1" class="tocxref"><span class="secno">3.5.3.6 </span>HTMLMediaElement</a><ul class="toc"><li class="tocline"><a href="#attributes-5" class="tocxref"><span class="secno">3.5.3.6.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#htmlobjectelement-1" class="tocxref"><span class="secno">3.5.3.7 </span>HTMLObjectElement</a><ul class="toc"><li class="tocline"><a href="#attributes-6" class="tocxref"><span class="secno">3.5.3.7.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#htmlscriptelement-1" class="tocxref"><span class="secno">3.5.3.8 </span>HTMLScriptElement</a><ul class="toc"><li class="tocline"><a href="#attributes-7" class="tocxref"><span class="secno">3.5.3.8.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#htmltrackelement-1" class="tocxref"><span class="secno">3.5.3.9 </span>HTMLTrackElement</a><ul class="toc"><li class="tocline"><a href="#attributes-8" class="tocxref"><span class="secno">3.5.3.9.1 </span>Attributes</a></li></ul></li></ul></li><li class="tocline"><a href="#handling-integrity-violations-1" class="tocxref"><span class="secno">3.5.4 </span>Handling integrity violations</a></li><li class="tocline"><a href="#elements-1" class="tocxref"><span class="secno">3.5.5 </span>Elements</a><ul class="toc"><li class="tocline"><a href="#the-a-element-1" class="tocxref"><span class="secno">3.5.5.1 </span>The <code>a</code> element</a></li><li class="tocline"><a href="#the-embed-element-1" class="tocxref"><span class="secno">3.5.5.2 </span>The <code>embed</code> element</a></li><li class="tocline"><a href="#the-iframe-element-1" class="tocxref"><span class="secno">3.5.5.3 </span>The <code>iframe</code> element</a></li><li class="tocline"><a href="#the-img-element-1" class="tocxref"><span class="secno">3.5.5.4 </span>The <code>img</code> element</a></li><li class="tocline"><a href="#the-link-element-1" class="tocxref"><span class="secno">3.5.5.5 </span>The <code>link</code> element</a></li><li class="tocline"><a href="#the-object-element-1" class="tocxref"><span class="secno">3.5.5.6 </span>The <code>object</code> element</a></li><li class="tocline"><a href="#the-script-element-1" class="tocxref"><span class="secno">3.5.5.7 </span>The <code>script</code> element</a></li><li class="tocline"><a href="#the-track-element-1" class="tocxref"><span class="secno">3.5.5.8 </span>The <code>track</code> element</a></li><li class="tocline"><a href="#the-audio-element-todo-1" class="tocxref"><span class="secno">3.5.5.9 </span>The <code>audio</code> element (TODO)</a></li><li class="tocline"><a href="#the-source-element-todo-1" class="tocxref"><span class="secno">3.5.5.10 </span>The <code>source</code> element (TODO)</a></li><li class="tocline"><a href="#the-video-element-todo-1" class="tocxref"><span class="secno">3.5.5.11 </span>The <code>video</code> element (TODO)</a></li></ul></li></ul></li><li class="tocline"><a href="#verification-of-css-loaded-subresources-1" class="tocxref"><span class="secno">3.6 </span>Verification of CSS-loaded subresources</a></li><li class="tocline"><a href="#verification-of-js-loaded-subresources-1" class="tocxref"><span class="secno">3.7 </span>Verification of JS-loaded subresources</a><ul class="toc"><li class="tocline"><a href="#workers-1" class="tocxref"><span class="secno">3.7.1 </span>Workers</a><ul class="toc"><li class="tocline"><a href="#worker-extension-1" class="tocxref"><span class="secno">3.7.1.1 </span>Worker extension</a><ul class="toc"><li class="tocline"><a href="#attributes-9" class="tocxref"><span class="secno">3.7.1.1.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#sharedworker-extension-1" class="tocxref"><span class="secno">3.7.1.2 </span>SharedWorker extension</a><ul class="toc"><li class="tocline"><a href="#attributes-10" class="tocxref"><span class="secno">3.7.1.2.1 </span>Attributes</a></li></ul></li><li class="tocline"><a href="#validation-2" class="tocxref"><span class="secno">3.7.1.3 </span>Validation</a></li></ul></li><li class="tocline"><a href="#xmlhttprequest-1" class="tocxref"><span class="secno">3.7.2 </span>XMLHttpRequest</a><ul class="toc"><li class="tocline"><a href="#the-integrity-attribute-3" class="tocxref"><span class="secno">3.7.2.1 </span>The <code>integrity</code> attribute</a></li><li class="tocline"><a href="#progress-events-1" class="tocxref"><span class="secno">3.7.2.2 </span>Progress events</a></li><li class="tocline"><a href="#validation-3" class="tocxref"><span class="secno">3.7.2.3 </span>Validation</a></li></ul></li></ul></li></ul></li><li class="tocline"><a href="#caching-optional-1" class="tocxref"><span class="secno">4. </span>Caching (Optional)</a><ul class="toc"><li class="tocline"><a href="#risks-1" class="tocxref"><span class="secno">4.1 </span>Risks</a><ul class="toc"><li class="tocline"><a href="#origin-confusion-1" class="tocxref"><span class="secno">4.1.1 </span>Origin confusion</a></li><li class="tocline"><a href="#mime-type-confusion-1" class="tocxref"><span class="secno">4.1.2 </span>MIME type confusion</a></li></ul></li><li class="tocline"><a href="#recommendations-1" class="tocxref"><span class="secno">4.2 </span>Recommendations</a></li></ul></li><li class="tocline"><a href="#proxies-1" class="tocxref"><span class="secno">5. </span>Proxies</a></li><li class="tocline"><a href="#security-considerations-1" class="tocxref"><span class="secno">6. </span>Security Considerations</a><ul class="toc"><li class="tocline"><a href="#insecure-channels-remain-insecure-1" class="tocxref"><span class="secno">6.1 </span>Insecure channels remain insecure</a></li><li class="tocline"><a href="#hash-collision-attacks-1" class="tocxref"><span class="secno">6.2 </span>Hash collision attacks</a></li><li class="tocline"><a href="#cross-origin-data-leakage-1" class="tocxref"><span class="secno">6.3 </span>Cross-origin data leakage</a></li></ul></li><li class="tocline"><a href="#acknowledgements-1" class="tocxref"><span class="secno">7. </span>Acknowledgements</a></li><li class="tocline"><a href="#references" class="tocxref"><span class="secno">A. </span>References</a><ul class="toc"><li class="tocline"><a href="#normative-references" class="tocxref"><span class="secno">A.1 </span>Normative references</a></li></ul></li></ul></section>



<section class="informative" typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="introduction-1">
  <!--OddPage--><h2 id="introduction" aria-level="1" role="heading"><span class="secno">1. </span>Introduction</h2><p><em>This section is non-normative.</em></p>

  <p>Sites and applications on the web are rarely composed of resources from
only a single origin. Authors pull scripts, images, fonts, etc. from a
wide variety of services and content delivery networks, and must trust
that the delivered representation is, in fact, what they expected to
load. If an attacker can trick a user into downloading content from
a hostile server (via DNS poisoning, or other such means), the author has
no recourse. Likewise, an attacker who can replace the file on the CDN server
has the ability to inject arbitrary content.</p>

  <p>Delivering resources over a secure channel mitigates some of this risk: with
TLS, <a href="http://tools.ietf.org/html/rfc6797">HSTS</a>, and <a href="http://tools.ietf.org/html/draft-ietf-websec-key-pinning">pinned public keys</a>, a user agent can be fairly certain
that it is indeed speaking with the server it believes it’s talking to. These
mechanisms, however, authenticate <em>only</em> the server, <em>not</em> the content. An
attacker (or admin!) with access to the server can manipulate content with
impunity. Ideally, authors would not only be able to pin the keys of a
server, but also pin the <em>content</em>, ensuring that an exact representation of
a resource, and <em>only</em> that representation, loads and executes.</p>

  <p>This document specifies such a validation scheme, extending several HTML
elements with a <code>integrity</code> attribute that contains a cryptographic hash of
the representation of the resource the author expects to load. For instance,
an author may wish to load jQuery from a shared server rather than hosting it
on their own origin. Specifying that the <em>expected</em> SHA-256 hash of
<code>https://code.jquery.com/jquery-1.10.2.min.js</code>
is <code>C6CB9UYIS9UJeqinPHWTHVqh_E1uhG5Twh-Y5qFQmYg</code> means
that the user agent can verify that the data it loads from that URL matches
that expected hash before executing the JavaScript it contains. This
integrity verification significantly reduces the risk that an attacker can
substitute malicious content.</p>

  <p>This example can be communicated to a user agent by adding the hash to a
<code>script</code> element, like so:</p>

  <pre><code>&lt;script src="https://code.jquery.com/jquery-1.10.2.min.js"
        integrity="ni:///sha-256;C6CB9UYIS9UJeqinPHWTHVqh_E1uhG5Twh-Y5qFQmYg?ct=application/javascript"&gt;
</code></pre>

  <p>Scripts, of course, are not the only resource type which would benefit
from integrity validation. The scheme specified here applies to all HTML
elements which trigger fetches, as well as to fetches triggered from CSS
and JavaScript.</p>

  <p>Moreover, integrity metadata may also be useful for purposes other than
validation. User agents may decide to use the integrity metadata as an
identifier in a local cache, for instance, meaning that common resources
(for example, JavaScript libraries) could be cached and retrieved once,
regardless of the URL from which they are loaded.</p>

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="goals-1">
    <h3 id="goals" aria-level="2" role="heading"><span class="secno">1.1 </span>Goals</h3>

    <ol>
      <li>
        <p>Compromise of the third-party service should not automatically mean
compromise of every site which includes its scripts. Content authors
will have a mechanism by which they can specify expectations for
content they load, meaning for example that they could load a
<em>specific</em> script, and not <em>any</em> script that happens to have a
particular URL.</p>
      </li>
      <li>
        <p>The verification mechanism should extend to all resource types that
a page may fetch in the course of its execution and rendering. Active
content (scripts, style, <code>iframe</code> contents, etc) are, of course,
critical, but inactive content such as images and fonts will also be
covered.</p>
      </li>
      <li>
        <p>The verification mechanism should have reporting functionality which
would inform the author that an invalid resource was downloaded.
Further it should be possible for an author to choose to run <em>only</em>
the reporting functionality, allowing potentially corrupt resources
to run on her site, but flagging violations for manual review.</p>
      </li>
      <li>
        <p>The metadata provided for verification may enable improvements to
user agents’ caching schemes: common resources such as JavaScript
libraries can be downloaded once, and only once, even if multiple
instances with distinct URLs are requested.</p>
      </li>
      <li>
        <p>(potentially) Relax mixed-content warnings for resources whose
integrity is verified. If the integrity metadata for a resource
is delivered over a secure channel, the user agent might choose to
allow loading the resource over an insecure channel.</p>
      </li>
      <li>
        <p>(potentially) Allow resources to be downloaded from non-canonical
sources (for instance, over an insecure channel) for performance,
but fall back to a canonical source if the non-canonical source
fails an integrity check. </p>
      </li>
    </ol>

    <div class="issue"><div class="issue-title" aria-level="3" role="heading" id="h_issue_1"><span>Issue 1</span></div><p class="">I’m not sure about #5 and #6. Get more detail from the WG about the
benefits that such a fallback system would enable. (mkwst)</p></div>
  </section>
  <!-- /Introduction::Goals -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="use-cases-examples">
    <h3 id="use-casesexamples" aria-level="2" role="heading"><span class="secno">1.2 </span>Use Cases/Examples</h3>

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="resource-integrity-1">
      <h4 id="resource-integrity" aria-level="3" role="heading"><span class="secno">1.2.1 </span>Resource Integrity</h4>

      <ul>
        <li>
          <p>An author wants to include JavaScript provided by a third-party
analytics service on her site. She wants, however, to ensure that only
the code she’s carefully reviewed is executed. She can do so by generating
<a href="#dfn-integrity-metadata">integrity metadata</a> for the script she’s planning on including, and
adding it to the <code>script</code> element she includes on her page:</p>

          <pre><code>&lt;script src="https://analytics-r-us.com/v1.0/include.js"
        integrity="ni:///sha-256;SDfwewFAE...wefjijfE?ct=application/javascript"&gt;&lt;/script&gt;
</code></pre>
        </li>
        <li>
          <p>An advertising network wishes to ensure that advertisements delivered via
third-party servers matches the code which they reviewed in order to reduce
the risk of accidental or malicious substitution of unreviewed content. By
adding <a href="#dfn-integrity-metadata">integrity metadata</a> to the <code>iframe</code> element wrapping the
advertisement, they can ensure that the third-party server delivers only
the agreed-upon content.</p>

          <pre><code>&lt;iframe src="https://awesome-ads.com/advertisement1.html"
        integrity="ni:///sha-256;kasfdsaffs...eoirW-e?ct=text/html"&gt;&lt;/iframe&gt;
</code></pre>
        </li>
        <li>
          <p>A user agent wishes to ensure that pieces of its UI which are rendered via
HTML (for example, Chrome’s New Tab Page) aren’t manipulated before display.
<a href="#dfn-integrity-metadata">Integrity metadata</a> mitigates the risk that altered JavaScript will run
in these page’s high-privilege context.</p>
        </li>
        <li>
          <p>The author of a mash-up wants to make sure her creation remains in a working
state. Adding <a href="#dfn-integrity-metadata">integrity metadata</a> to external subresources defines an
expected revision of the included files. The author can then use the reporting
functionality to be notified of changes to the included resources.</p>
        </li>
      </ul>

    </section>
    <!-- Introduction::UseCases::Integrity -->
    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="downloads-1">
      <h4 id="downloads" aria-level="3" role="heading"><span class="secno">1.2.2 </span>Downloads</h4>

      <ul>
        <li>
          <p>A software distribution service wants to ensure that files are correctly
downloaded. It can do so by adding <a href="#dfn-integrity-metadata">integrity metadata</a> to the <code>a</code>
elements which users click on to trigger a download:</p>

          <pre><code>&lt;a href="https://software-is-nice.com/awesome.exe"
   integrity="ni:///sha-256;fkfrewFRFEFHJR...wfjfrErw?ct=application/octet-stream"
   download&gt;...&lt;/a&gt;
</code></pre>
        </li>
      </ul>

    </section>
    <!-- Introduction::UseCases::Downloads -->
    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="fallback-1">
      <h4 id="fallback" aria-level="3" role="heading"><span class="secno">1.2.3 </span>Fallback</h4>

      <ul>
        <li>
          <p>An author wishes to load a resource over an insecure channel for performance
reasons, but fall back to a secure channel if the insecurely-loaded resource
is manipulated. She can do this by adding <a href="#dfn-integrity-metadata">integrity metadata</a> and a
<a href="#the-noncanonical-src-attribute">non-canonical source</a> to the <code>script</code> element:</p>

          <pre><code>&lt;script src="https://rockin-resources.com/script.js"
        noncanonical-src="http://insecurity-is-inherent.net/script.js"
        integrity="ni:///sha-256;asijfiqu4t12...woeji3W?ct=application/javascript"&gt;&lt;/script&gt;
</code></pre>
        </li>
      </ul>

    </section>
    <!-- /Introduction::Use Cases::Fallback -->
  </section>
  <!-- /Introduction::Use Cases -->
</section>
<!-- /Introduction -->

<section id="conformance" typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter"><!--OddPage--><h2 aria-level="1" role="heading" id="h2_conformance"><span class="secno">2. </span>Conformance</h2>
<p>
  As well as sections marked as non-normative, all authoring guidelines, diagrams, examples,
  and notes in this specification are non-normative. Everything else in this specification is
  normative.
</p>
<p>
  The key words <em class="rfc2119" title="MUST">MUST</em>, <em class="rfc2119" title="MUST NOT">MUST NOT</em>, <em class="rfc2119" title="REQUIRED">REQUIRED</em>, <em class="rfc2119" title="SHOULD">SHOULD</em>, <em class="rfc2119" title="SHOULD NOT">SHOULD NOT</em>, <em class="rfc2119" title="RECOMMENDED">RECOMMENDED</em>, <em class="rfc2119" title="MAY">MAY</em>,
  and <em class="rfc2119" title="OPTIONAL">OPTIONAL</em> in this specification are to be interpreted as described in [<cite><a class="bibref" href="#bib-RFC2119">RFC2119</a></cite>].
</p>

  <p>Conformance requirements phrased as algorithms or specific steps can be
implemented in any manner, so long as the end result is equivalent. In
particular, the algorithms defined in this specification are intended to
be easy to understand and are not intended to be performant. Implementers
are encouraged to optimize.</p>

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="key-concepts-and-terminology-1">
    <h3 id="key-concepts-and-terminology" aria-level="2" role="heading"><span class="secno">2.1 </span>Key Concepts and Terminology</h3>

    <p>This section defines several terms used throughout the document.</p>

    <p>The term <dfn id="dfn-digest">digest</dfn> refers to the base64url-encoded result of
executing a cryptographic hash function on an arbitrary block of data.</p>

    <p>A <dfn id="dfn-secure-channel">secure channel</dfn> is any communication mechanism that the user
agent has defined as “secure” (typically limited to HTTP over Transport
Layer Security (TLS) [<cite><a class="bibref" href="#bib-RFC2818">RFC2818</a></cite>]).</p>

    <p>An <dfn id="dfn-insecure-channel">insecure channel</dfn> is any communication mechanism other than
those the user agent has defined as “secure”.</p>

    <p>The term <dfn id="dfn-origin">origin</dfn> is defined in the Origin specification.
[<cite><a class="bibref" href="#bib-RFC6454">RFC6454</a></cite>]</p>

    <p>The <dfn id="dfn-mime-type">MIME type</dfn> of a resource is a technical hint about the use
and format of that resource. [<cite><a class="bibref" href="#bib-MIMETYPE">MIMETYPE</a></cite>]</p>

    <p>The <dfn id="dfn-entity-body">entity body</dfn>, <dfn id="dfn-transfer-encoding">transfer encoding</dfn>, <dfn id="dfn-content-encoding">content
encoding</dfn> and <dfn id="dfn-message-body">message body</dfn> of a resource is defined by the
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec7.html">HTTP 1.1 specification, section 7.2</a>. [<cite><a class="bibref" href="#bib-HTTP11">HTTP11</a></cite>]</p>

    <p>A <dfn id="dfn-base64url-encoding">base64url encoding</dfn> is defined in
<a href="http://tools.ietf.org/html/rfc4648#section-5">RFC 4648, section 5</a>. In a nutshell, it replaces the characters
U+002B PLUS SIGN (<code>+</code>) and U+002F SOLIDUS (<code>/</code>) characters in normal base64
encoding with the U+002D HYPHEN-MINUS (<code>-</code>) and U+005F LOW LINE (<code>_</code>)
characters, respectively. [<cite><a class="bibref" href="#bib-RFC4648">RFC4648</a></cite>]</p>

    <p>The Augmented Backus-Naur Form (ABNF) notation used in this document is
specified in RFC 5234. [<cite><a class="bibref" href="#bib-ABNF">ABNF</a></cite>]</p>

    <p>The <dfn id="dfn-sha-256">SHA-256</dfn>, <dfn id="dfn-sha-384">SHA-384</dfn>, and <dfn id="dfn-sha-512">SHA-512</dfn> are part
of the <dfn id="dfn-sha-2">SHA-2</dfn> set of cryptographic hash functions defined by the
NIST in <a href="http://csrc.nist.gov/groups/STM/cavp/documents/shs/sha256-384-512.pdf">“Descriptions of SHA-256, SHA-384, and SHA-512”</a>.</p>

  </section>
</section>

<section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="framework-1">
  <!--OddPage--><h2 id="framework" aria-level="1" role="heading"><span class="secno">3. </span>Framework</h2>

  <p>The integrity verification mechanism specified here boils down to the
process of generating a sufficiently strong cryptographic digest for a
resource, and transmitting that digest to a user agent so that it may be
used when fetching the resource.</p>

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="integrity-metadata-1">
    <h3 id="integrity-metadata" aria-level="2" role="heading"><span class="secno">3.1 </span>Integrity metadata</h3>

    <p>To verify the integrity of a resource, a user agent requires <dfn id="dfn-integrity-metadata">integrity
metadata</dfn>, which consists of the following pieces of information:</p>

    <ul>
      <li>cryptographic hash function</li>
      <li><a href="#dfn-digest">digest</a></li>
      <li>the resource’s MIME type</li>
    </ul>

    <p>The hash function and digest <em class="rfc2119" title="MUST">MUST</em> be provided in order to validate a
resource’s integrity. The MIME type <em class="rfc2119" title="SHOULD">SHOULD</em> be provided, as it mitigates the
risk of certain attack vectors (see <a href="#mime-type-confusion">MIME Type confusion</a> in
this document’s Security Considerations section).</p>

    <p>This metadata is generally encoded as a “named information” (<code>ni</code>) URI, as
defined in RFC6920. [<cite><a class="bibref" href="#bib-RFC6920">RFC6920</a></cite>]</p>

    <p>For example, given a resource containing only the string “Hello, world!”,
an author might choose <a href="#dfn-sha-2">SHA-256</a> as a hash function.
<code>-MO_YqmqPm_BYZwlDkir51GTc9Pt9BvmLrXcRRma8u8</code> is the base64url-encoded
digest that results. This can be encoded as an <code>ni</code> URI as follows:</p>

    <pre><code>ni:///sha-256;-MO_YqmqPm_BYZwlDkir51GTc9Pt9BvmLrXcRRma8u8
</code></pre>

    <p>Or, if the author further wishes to specify the content type (<code>text/plain</code>):</p>

    <pre><code>ni:///sha-256;-MO_YqmqPm_BYZwlDkir51GTc9Pt9BvmLrXcRRma8u8?ct=text/plain
</code></pre>

    <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_1"><span>Note</span></div><div class="">
      <p>Digests may be generated using any number of utilities. <a href="http://www.openssl.org/">OpenSSL</a>, for
example, is quite commonly available. The example in this section is the
result of the following command line:</p>

      <pre><code>echo -n "Hello, world." | openssl dgst -sha256 -binary | openssl enc -base64 | sed -e 's/+/-/g' -e 's/\//_/g'
</code></pre>

    </div></div>

  </section>
  <!-- /Framework::Required metadata -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="cryptographic-hash-functions-1">
    <h3 id="cryptographic-hash-functions" aria-level="2" role="heading"><span class="secno">3.2 </span>Cryptographic hash functions</h3>

    <p>Conformant user agents <em class="rfc2119" title="MUST">MUST</em> support the <a href="#dfn-sha-2">SHA-256</a> and <a href="#dfn-sha-2">SHA-512</a>
cryptographic hash functions for use as part of a resource’s
<a href="#dfn-integrity-metadata">integrity metadata</a>.</p>
  </section>
  <!-- /Framework::Cryptographic hash functions -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="resource-verification-algorithms-1">
    <h3 id="resource-verification-algorithms" aria-level="2" role="heading"><span class="secno">3.3 </span>Resource verification algorithms</h3>

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="apply-algorithm-to-resource">
      <h4 id="apply-varalgorithmvar-to-varresourcevar" aria-level="3" role="heading"><span class="secno">3.3.1 </span>Apply <var>algorithm</var> to <var>resource</var></h4>

      <ol>
        <li>If <var>algorithm</var> is not a hash function recognized and supported
by the user agent, return <code>null</code>.</li>
        <li>Let <var>result</var> be the result of applying <var>algorithm</var> to
the content of the <a href="#dfn-entity-body">entity body</a> of <var>resource</var>, including any
content coding that has been applied, but not including any
transfer encoding applied to the message body.</li>
        <li>Let <var>encodedResult</var> be result of base64url-encoding
<var>result</var>.</li>
        <li>Strip any trailing U+003D EQUALS SIGN (<code>=</code>) characters from
<var>encodedResult</var>.</li>
        <li>Return <var>encodedResult</var>.</li>
      </ol>

      <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_2"><span>Issue 2</span></div><p class="">Step 2 is pulled from the <code>content-md5</code> definition in [<cite><a class="bibref" href="#bib-HTTP11">HTTP11</a></cite>]. It’s
unclear that it’s what we want. See  <a href="http://lists.w3.org/Archives/Public/public-webappsec/2013Dec/0048.html">bzbarsky’s WG post on this topic</a></p></div>

    </section>
    <!-- Algorithms::apply -->
    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="is-resource-eligible-for-integrity-validation">
      <h4 id="is-varresourcevar-eligible-for-integrity-validation" aria-level="3" role="heading"><span class="secno">3.3.2 </span>Is <var>resource</var> eligible for integrity validation</h4>

      <p>In order to mitigate an attackers ability to read data cross-origin by
brute-forcing values via integrity checks, resources are only eligible
for such checks if they are same-origin, publicly cachable, or is the
result of a granted the loading origin explicit access via CORS. [<a href="http://www.w3.org/TR/html5/infrastructure.html#cors-cross-origin">CORS</a>]</p>

      <p>Certain HTTP headers can also change the way the resource behaves in
ways which integrity checking cannot account for. If the resource
contains these headers, it is ineligible for integrity validation:</p>

      <ul>
        <li><code>WWW-Authenticate</code> hides resources behind a login; such non-public
resources are excluded from integrity checks.</li>
        <li><code>Refresh</code> can cause IFrame contents to transparently redirect to an
unintended target, bypassing the integrity check.</li>
      </ul>

      <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_3"><span>Issue 3</span></div><p class="">Consider the impact of other headers: <code>Content-Length</code>, <code>Content-Range</code>,
etc. Is there danger there?</p></div>

      <p>The following algorithm details these restrictions:</p>

      <ol>
        <li>Let <var>request</var> be the request which fetched
<var>resource</var>.</li>
        <li>If <var>resource</var> contains any of the following HTTP headers,
return <code>false</code>:
          <ul>
            <li><code>WWW-Authenticate</code></li>
            <li><code>Refresh</code></li>
          </ul>
        </li>
        <li>If the <a href="http://fetch.spec.whatwg.org/#concept-request-mode">mode</a> of <var>request</var> is <code>CORS</code>,
return <code>true</code>.</li>
        <li>If the <a href="http://fetch.spec.whatwg.org/#concept-request-origin">origin</a> of <var>request</var> is
<var>resource</var>’s origin, return <code>true</code>.</li>
        <li>If <var>resource</var> is <a href="https://svn.tools.ietf.org/svn/wg/httpbis/draft-ietf-httpbis/latest/p6-cache.html#response.cacheability">cachable by a shared cache</a>, as defined
in [<cite><a class="bibref" href="#bib-HTTP11">HTTP11</a></cite>], return <code>true</code>.</li>
        <li>Return <code>false</code>.</li>
      </ol>

      <div class="note"><div class="note-title" aria-level="4" role="heading" id="h_note_2"><span>Note</span></div><p class="">Step 2 returns <code>true</code> if the resource was a CORS-enabled request. If the
resource failed the CORS checks, it won’t be available to us for integrity
checking because it won’t have loaded successfully.</p></div>

    </section>
    <!-- Algorithms::eligible -->
    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="does-resource-match-metadata">
      <h4 id="does-varresourcevar-match-varmetadatavar" aria-level="3" role="heading"><span class="secno">3.3.3 </span>Does <var>resource</var> match <var>metadata</var>?</h4>

      <ol>
        <li>If <var>metadata</var> is the empty string, return <code>true</code>.</li>
        <li>If <var>resource</var>’s URL’s scheme is <code>about</code>, return <code>true</code>.</li>
        <li>If <var>metadata</var> is not a valid “named information” (<code>ni</code>) URI,
return <code>false</code>.</li>
        <li>If <a href="#is-resource-eligible-for-integrity-validation"><var>resource</var> is not eligible for integrity
valiation</a>, return <code>false</code>.</li>
        <li>Let <var>algorithm</var> be the <var>alg</var> component of
<var>metadata</var>.</li>
        <li>Let <var>expectedValue</var> be the <var>val</var> component of
<var>metadata</var>.</li>
        <li>Let <var>expectedType</var> be the value of <var>metadata</var>’s <code>ct</code>
query string parameter.</li>
        <li>If <var>expectedType</var> is not the empty string, and is not a
case-insensitive match for <var>resource</var>’s MIME type,
return <code>false</code>.</li>
        <li>Let <var>actualValue</var> be the result of <a href="#apply-algorithm-to-resource">applying
<var>algorithm</var> to <var>resource</var></a>.</li>
        <li>If <var>actualValue</var> is <code>null</code>, return <code>false</code>.</li>
        <li>If <var>actualValue</var> is a case-sensitive match for
<var>expectedValue</var>, return <code>true</code>. Otherwise, return <code>false</code>.</li>
      </ol>

      <div class="note"><div class="note-title" aria-level="4" role="heading" id="h_note_3"><span>Note</span></div><p class="">If <var>expectedType</var> is the empty string in #6, it would
be reasonable for the user agent to warn the page’s author about the
dangers of MIME type confusion attacks via its developer console.</p></div>

    </section>
    <!-- Algorithms::Match -->
  </section>
  <!-- Algorithms -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="modifications-to-fetch-1">
    <h3 id="modifications-to-fetch" aria-level="2" role="heading"><span class="secno">3.4 </span>Modifications to Fetch</h3>

    <p>The Fetch specification should contain the following modifications in order
to enable the rest of this specification’s work:</p>

    <ol>
      <li>
        <p>The following text should be added to section 2.2: “A
<a href="http://fetch.spec.whatwg.org/#concept-request">request</a> has an associated <a href="#dfn-integrity-metadata">integrity metadata</a>.
Unless stated otherwise, a request’s integrity metadata is the empty
string.”</p>
      </li>
      <li>
        <p>The following text should be added to section 2.3: “A
<a href="http://fetch.spec.whatwg.org/#concept-response">response</a> has an associated integrity state, which
is one of <code>indeterminate</code>, <code>pending</code>, <code>corrupt</code>, and <code>intact</code>. Unless
stated otherwise, it is <code>indeterminate</code>.</p>
      </li>
      <li>
        <p>Perform the following steps before executing both the “basic fetch” and
“CORS fetch with preflight” algorithms:</p>

        <ol>
          <li>
            <p>If <var>request</var>’s integrity metadata is the empty string, set
<var>response</var>’s integrity state to <code>indeterminate</code>. Otherwise:</p>

            <ol>
              <li>Set <var>response</var>’s integrity state to <code>pending</code>.</li>
              <li>Include a <code>Cache-Control</code> header whose value is “no-transform”.</li>
              <li>If <var>request</var>’s integrity metadata contains a content
type:
                <ol>
                  <li>Set <var>request</var>’s <code>Accept</code> header value to the value
of <var>request</var>’s integrity metadata’s content type.</li>
                </ol>
              </li>
            </ol>
          </li>
        </ol>
      </li>
      <li>
        <p>Add the following step before step #1 of the handling of 401 status
codes for both “basic fetch” and “CORS fetch with preflight” algorithms:</p>

        <ol>
          <li>If <var>request</var>’s integrity state is <code>pending</code>, set
<var>response</var>’s integrity state to <code>corrupt</code> and return
<var>response</var>.</li>
        </ol>
      </li>
      <li>
        <p>Before firing the <a href="http://fetch.spec.whatwg.org/#process-request-end-of-file">process request end-of-file</a> event for any
<var>request</var>:</p>

        <ol>
          <li>
            <p>If the <var>request</var>’s integrity metadata is the empty string, set
the <var>response</var>’s integrity state to <code>indeterminate</code> and
skip directly to firing the event.</p>
          </li>
          <li>
            <p>If <var>response</var> <a href="#does-resource-match-metadata">matches</a> the request’s integrity
metadata, set the <var>response</var>’s integrity state to <code>intact</code>
and skip directly to firing the event.</p>
          </li>
          <li>
            <p>Set the <var>response</var>’s integrity state to <code>corrupt</code>
and skip directly to firing the event.</p>
          </li>
        </ol>
      </li>
    </ol>

  </section>

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="verification-of-html-document-subresources-1">
    <h3 id="verification-of-html-document-subresources" aria-level="2" role="heading"><span class="secno">3.5 </span>Verification of HTML document subresources</h3>

    <p>A variety of HTML elements result in requests for resources that are to be
embedded into the document, or executed in its context. To support integrity
metadata for each of these, and new elements that are added in the future,
a new <code>integrity</code> attribute is added to the list of content attributes for
the <code>a</code>, <code>audio</code>, <code>embed</code>, <code>iframe</code>, <code>link</code>, <code>object</code>, <code>script</code>, <code>source</code>,
<code>track</code>, and <code>video</code> elements.</p>

    <p>A corresponding <code>integrity</code> IDL attribute which <a href="http://www.w3.org/TR/html5/infrastructure.html#reflect">reflects</a> the
value each element’s <code>integrity</code> content attribute is added to the
<code>HTMLAnchorElement</code>, <code>HTMLMediaElement</code>, <code>HTMLEmbedElement</code>,
<code>HTMLIframeElement</code>, <code>HTMLLinkElement</code>, <code>HTMLObjectElement</code>,
<code>HTMLScriptElement</code>, <code>HTMLSourceElement</code>, and <code>HTMLTrackElement</code>
interfaces.</p>

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-integrity-attribute-2">
      <h4 id="the-integrity-attribute" aria-level="3" role="heading"><span class="secno">3.5.1 </span>The <code>integrity</code> attribute</h4>

      <p>The <code>integrity</code> attribute represents <a href="#dfn-integrity-metadata">integrity metadata</a> for an element.
The value of the attribute <em class="rfc2119" title="MUST">MUST</em> be either the empty string, or one
valid “named information” (<code>ni</code>) URI [<cite><a class="bibref" href="#bib-RFC6920">RFC6920</a></cite>], as described by the
following ABNF grammar:</p>

      <pre><code>integrity-metatata = "" / 1#( *WSP NI-URL ) *WSP ]
</code></pre>

      <p>The <code>NI-URL</code> rule is defined in <a href="http://tools.ietf.org/html/rfc6920#section3">RFC6920, section 3, figure 4</a>.</p>

      <p>The <code>integrity</code> IDL attribute must <a href="http://www.w3.org/TR/html5/infrastructure.html#reflect">reflect</a> the <code>integrity</code> content attribute.</p>

      <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_4"><span>Issue 4</span></div><p class="">We should consider supporting multiple <code>ni</code> URLs, which could allow migration
between algorithms.</p></div>
    </section>
    <!-- /Framework::HTML::integrity -->

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-noncanonical-src-attribute-todo-1">
      <h4 id="the-noncanonical-src-attribute-todo" aria-level="3" role="heading"><span class="secno">3.5.2 </span>The <code>noncanonical-src</code> attribute (TODO)</h4>

      <p>Authors <em class="rfc2119" title="MAY">MAY</em> opt-in to a fallback mechanism whereby user agents would initially
attempt to load resources from a non-canonical source (perhaps over HTTP, for
performance and caching reasons). If that fetch failed an integrity check, the
user agent would <a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">report a violation</a>, and retry the fetch using a canonical
URL (perhaps over HTTPS).</p>

      <p>The non-canonical URL is specified via a <code>noncanonical-src</code> attribute. For
example:</p>

      <pre><code>&lt;script src="http://example.com/script.js"
        noncanonical-src="http://cdn.example.com/script.js"
        integrity="ni:///sha-256;jsdfhiuwergn...vaaetgoifq?ct=application/javascript"&gt;&lt;/script&gt;
</code></pre>

      <p>The <code>noncanonicalSrc</code> IDL attribute <em class="rfc2119" title="MUST">MUST</em> <a href="http://www.w3.org/TR/html5/infrastructure.html#reflect">reflect</a> the <code>noncanonical-src</code>
content attribute.</p>

      <p>The noncanonical resource <em class="rfc2119" title="MUST">MUST</em> be fetched with its <a href="http://fetch.spec.whatwg.org/#concept-request-omit-credentials-mode">omit credentials
mode</a> set to <code>always</code>, to prevent leakage of cookies across insecure
channels.</p>

      <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_5"><span>Issue 5</span></div><p class="">This attribute (and fallback in general) only makes sense if we care
about allowing cache-friendly (read “HTTP”) URLs to load in an HTTPS context
without warnings. I’m not sure we do, so I’m not going to put too much
thought into the details here before we discuss things a bit more. (mkwst)</p></div>
    </section>
    <!-- /Framework::HTML::noncanonical-src -->

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="element-interface-extensions-1">
      <h4 id="element-interface-extensions" aria-level="3" role="heading"><span class="secno">3.5.3 </span>Element interface extensions</h4>

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmlanchorelement-1">
        <h5 id="htmlanchorelement" aria-level="4" role="heading"><span class="secno">3.5.3.1 </span>HTMLAnchorElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLAnchorElement">partial interface <span class="idlInterfaceID">HTMLAnchorElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLAnchorElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes"><h6 aria-level="5" role="heading" id="h6_attributes"><span class="secno">3.5.3.1.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLAnchorElement-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLAnchorElement -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmlembedelement-1">
        <h5 id="htmlembedelement" aria-level="4" role="heading"><span class="secno">3.5.3.2 </span>HTMLEmbedElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLObjectElement">partial interface <span class="idlInterfaceID">HTMLObjectElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLObjectElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-1"><h6 aria-level="5" role="heading" id="h6_attributes-1"><span class="secno">3.5.3.2.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLObjectElement-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLEmbedElement -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmliframeelement-1">
        <h5 id="htmliframeelement" aria-level="4" role="heading"><span class="secno">3.5.3.3 </span>HTMLIFrameElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLIFrameElement">partial interface <span class="idlInterfaceID">HTMLIFrameElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLIFrameElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-2"><h6 aria-level="5" role="heading" id="h6_attributes-2"><span class="secno">3.5.3.3.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLIFrameElement-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLIFrameElement -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmlimageelement-1">
        <h5 id="htmlimageelement" aria-level="4" role="heading"><span class="secno">3.5.3.4 </span>HTMLImageElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLImageElement">partial interface <span class="idlInterfaceID">HTMLImageElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLImageElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-3"><h6 aria-level="5" role="heading" id="h6_attributes-3"><span class="secno">3.5.3.4.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLImageElement-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLImageElement -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmllinkelement-1">
        <h5 id="htmllinkelement" aria-level="4" role="heading"><span class="secno">3.5.3.5 </span>HTMLLinkElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLLinkElement">partial interface <span class="idlInterfaceID">HTMLLinkElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLLinkElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-4"><h6 aria-level="5" role="heading" id="h6_attributes-4"><span class="secno">3.5.3.5.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLLinkElement-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLLinkElement -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmlmediaelement-1">
        <h5 id="htmlmediaelement" aria-level="4" role="heading"><span class="secno">3.5.3.6 </span>HTMLMediaElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLMediaElement">partial interface <span class="idlInterfaceID">HTMLMediaElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLMediaElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-5"><h6 aria-level="5" role="heading" id="h6_attributes-5"><span class="secno">3.5.3.6.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLMediaElement-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLMediaElement -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmlobjectelement-1">
        <h5 id="htmlobjectelement" aria-level="4" role="heading"><span class="secno">3.5.3.7 </span>HTMLObjectElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLObjectElement-1">partial interface <span class="idlInterfaceID">HTMLObjectElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLObjectElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-6"><h6 aria-level="5" role="heading" id="h6_attributes-6"><span class="secno">3.5.3.7.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLObjectElement-integrity-1"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLObjectElement -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmlscriptelement-1">
        <h5 id="htmlscriptelement" aria-level="4" role="heading"><span class="secno">3.5.3.8 </span>HTMLScriptElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLScriptElement">partial interface <span class="idlInterfaceID">HTMLScriptElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLScriptElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-7"><h6 aria-level="5" role="heading" id="h6_attributes-7"><span class="secno">3.5.3.8.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLScriptElement-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLScriptElement -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="htmltrackelement-1">
        <h5 id="htmltrackelement" aria-level="4" role="heading"><span class="secno">3.5.3.9 </span>HTMLTrackElement</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-HTMLTrackElement">partial interface <span class="idlInterfaceID">HTMLTrackElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLTrackElement-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-8"><h6 aria-level="5" role="heading" id="h6_attributes-8"><span class="secno">3.5.3.9.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-HTMLTrackElement-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of this element’s <code>integrity</code> attribute</dd></dl></section>
      </section>
      <!-- /Framework::HTML::Interface extensions::HTMLTrackElement -->

    </section>
    <!-- /Framework::HTML::Interface extensions -->
    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="handling-integrity-violations-1">
      <h4 id="handling-integrity-violations" aria-level="3" role="heading"><span class="secno">3.5.4 </span>Handling integrity violations</h4>

      <p>Documents may specify the behavior of a failed integrity check by delivering
a <a href="http://w3.org/TR/CSP11">Content Security Policy</a> which contains an <code>integrity-policy</code>
directive, defined by the following ABNF grammar:</p>

      <pre><code>directive-name  = "integrity-policy"
directive-value = 1#failure-mode [ "require-for-all" ]
failure-mode    = ( "block" / "report" / "fallback" )
</code></pre>

      <p>A document’s <dfn id="dfn-integrity-policy">integrity policy</dfn> is the value of the
<code>integrity-policy</code> directive, if explicitly provided as part of the
document’s Content Security Policy, or <code>block</code> otherwise.</p>

      <p>If the document’s integrity policy contains <code>block</code>, the user agent <em class="rfc2119" title="MUST">MUST</em> refuse
to render or execute resources that fail an integrity check, <em>and</em> <em class="rfc2119" title="MUST">MUST</em>
<a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">report a violation</a>.</p>

      <p>If the document’s integrity policy contains <code>report</code>, the user agent <em class="rfc2119" title="MAY">MAY</em> render
or execute resources that fail an integrity check, <em>but</em> <em class="rfc2119" title="MUST">MUST</em>
<a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">report a violation</a>.</p>

      <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_6"><span>Issue 6</span></div><p class="">If the document’s integrity policy contains <code>fallback</code>, the user agent <em class="rfc2119" title="MUST">MUST</em>
refuse to render or execute resources that fail an integrity check, <em>and</em>
<em class="rfc2119" title="MUST">MUST</em> <a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">report a violation</a>. The user agent <em class="rfc2119" title="MAY">MAY</em> additionally choose to load
a fallback resource as specified for each relevant element. If the fallback
resource fails an integrity check, the user agent <em class="rfc2119" title="MUST">MUST</em> refuse to render or
execute the resource, <em>and</em> <em class="rfc2119" title="MUST">MUST</em> <a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">report a(nother)
violation</a>. (See <a href="#the-noncanonical-src-attribute">the <code>noncanonical-src</code>
attribute</a> for a strawman of how that might look).</p></div>

      <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_7"><span>Issue 7</span></div><p class="">If the document’s integrity policy contains <code>require-for-all</code>, the user agent
<em class="rfc2119" title="MUST">MUST</em> treat the lack of <a href="#dfn-integrity-metadata">integrity metadata</a> for an resource as automatic
failure, refuse to fetch the resource, and <a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">report a violation</a>.</p></div>

    </section>

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="elements-1">
      <h4 id="elements" aria-level="3" role="heading"><span class="secno">3.5.5 </span>Elements</h4>

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-a-element-1">
        <h5 id="the-a-element" aria-level="4" role="heading"><span class="secno">3.5.5.1 </span>The <code>a</code> element</h5>

        <p>If an <code>a</code> element has both <code>integrity</code> and <code>download</code> attributes, the user
agent has all the data it needs in order to verify the integrity of the
downloaded resource. This is the only type of download we can safely make
promises about, so it is the only type of download that we support. If
integrity metadata is added to any <code>a</code> element that does not explicitly
request that the resource it points to be downloaded, user agents <em class="rfc2119" title="MUST">MUST</em>
treat the link as broken.</p>

        <p>Before <a href="http://www.w3.org/TR/html5/links.html#following-hyperlinks">following a hyperlink</a>, the user agent <em class="rfc2119" title="MUST">MUST</em> run the following steps:</p>

        <ol>
          <li>If <var>subject</var> has an <code>integrity</code> attribute whose value is not the
empty string, then:
            <ol>
              <li>The user agent <em class="rfc2119" title="MAY">MAY</em> report an error to the user in a
user-agent-specific manner.</li>
              <li>Abort the <a href="http://www.w3.org/TR/html5/links.html#following-hyperlinks">following a hyperlink</a> algorithm.</li>
            </ol>
          </li>
        </ol>

        <p>Replace step 6 of the <a href="http://www.w3.org/TR/html5/links.html#downloading-hyperlinks">downloads a hyperlink</a> algorithm with the following:</p>

        <ol start="6">
          <li>If the <code>integrity</code> attribute of that element is not the empty string, and
the element <em>does not</em> have a <code>download</code> attribute, abort these steps.</li>
          <li>Fetch <var>URL</var> with <a href="#dfn-integrity-metadata">integrity metadata</a> set to the value of the
<code>integrity</code> attribute of that element, and handle the resulting resource
<a href="http://www.w3.org/TR/html5/links.html#as-a-download">as a download</a>.</li>
        </ol>

        <p>When handling a resource <a href="http://www.w3.org/TR/html5/links.html#as-a-download">as a download</a>, perform the following step before
providing a user with a way to save the resource for later use:</p>

        <ul>
          <li>If <var>response</var>’s integrity state is <code>corrupt</code> and the document’s
<a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>, the user agent <em class="rfc2119" title="MUST">MUST</em> <a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">report a violation</a>,
<em>and</em> <em class="rfc2119" title="MUST">MUST</em> abort the download.</li>
        </ul>

        <div class="note"><div class="note-title" aria-level="5" role="heading" id="h_note_4"><span>Note</span></div><div class="">
          <p>Note that this will cover <em>only</em> downloads triggered explicitly by adding a
<code>download</code> attribute to an <code>a</code> element. Such a link might look like the following:</p>

          <pre><code>&lt;a href="https://example.com/file.zip"
   integrity="ni:///sha256;skjdsfkafinqfb...ihja_gqg?ct=application/octet-stream"
   download&gt;Download!&lt;/a&gt;
</code></pre>
        </div></div>

      </section>
      <!-- /Framework::HTML::Elements::a -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-embed-element-1">
        <h5 id="the-embed-element" aria-level="4" role="heading"><span class="secno">3.5.5.2 </span>The <code>embed</code> element</h5>

        <p>When fetching an URL via step 2 of the <a href="http://www.w3.org/TR/html5/embedded-content-0.html#update-the-image-data"><code>embed</code> element setup steps</a>
algorithm:</p>

        <ol>
          <li>Set the <a href="#dfn-integrity-metadata">integrity metadata</a> of the request to the value
of the element’s <code>integrity</code> attribute.</li>
        </ol>

        <p>Before running the task queued by the networking task source once the URL has
been fetched, first perform the following steps:</p>

        <ol>
          <li>If the response’s integrity state is <code>corrupt</code>:
            <ol>
              <li>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>:
                <ol>
                  <li>Set the element’s <code>type</code> attribute to the empty string.</li>
                  <li>Skip to step 4 of the algorithm.</li>
                </ol>
              </li>
              <li><a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">Report a violation</a>.</li>
            </ol>
          </li>
        </ol>

      </section>
      <!-- /Framework::HTML::Elements::embed -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-iframe-element-1">
        <h5 id="the-iframe-element" aria-level="4" role="heading"><span class="secno">3.5.5.3 </span>The <code>iframe</code> element</h5>

        <p>When content is to be loaded into the <a href="http://www.w3.org/TR/html5/browsers.html#child-browsing-context">child browsing context</a> created
by an <code>iframe</code>, perform fetches with the <a href="#dfn-integrity-metadata">integrity metadata</a> set to the
value of the <code>iframe</code> element’s <code>integrity</code> attribute. Moreover:</p>

        <ul>
          <li>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>, then the user
agent <em class="rfc2119" title="MUST">MUST</em> delay rendering the content until the
<a href="http://www.w3.org/TR/html5/infrastructure.html#fetch">fetching algorithm</a>’s task to <a href="http://fetch.spec.whatwg.org/#process-request-end-of-file">process request end-of-file</a>
completes.</li>
          <li>When the <a href="http://fetch.spec.whatwg.org/#process-request-end-of-file">process request end-of-file</a> task completes:
            <ol>
              <li>If the request’s integrity state is <code>corrupt</code>:
                <ol>
                  <li>If <var>resource</var> is <a href="http://tools.ietf.org/html/rfc6454#section-5">same origin</a> with the document’s
browsing context owner <code>iframe</code> element’s Document’s origin, then
<a href="http://www.w3.org/TR/html5/webappapis.html#queue-a-task">queue a task</a> to <a href="http://www.w3.org/TR/html5/webappapis.html#fire-a-simple-event">fire a simple event</a> named <code>error</code> at the
<code>iframe</code> element (this will not fire for cross-origin requests, to
avoid leaking data about those resource’s content).</li>
                  <li><a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">Report a violation</a>.</li>
                  <li><a href="http://www.w3.org/TR/html5/browsers.html#navigate">Navigate</a> the child browsing context to <code>about:blank</code>.</li>
                </ol>
              </li>
            </ol>
          </li>
        </ul>

        <div class="issue"><div class="issue-title" aria-level="5" role="heading" id="h_issue_8"><span>Issue 8</span></div><p class="">How does this effect things like the preload scanner? How much work is it
going to be for vendors to change the “display whatever we’ve got, ASAP!”
behavior that makes things fast for users? How much impact will there be
on user experience, especially for things like ads, where this kind of
validation has the most value?</p></div>

        <div class="issue"><div class="issue-title" aria-level="5" role="heading" id="h_issue_9"><span>Issue 9</span></div><p class="">How do we deal with navigations in the child browsing context? Are they
simply disallowed? If so, does that make sense? It might for ads, but
what about other use-cases?</p></div>

      </section>
      <!-- /Framework::HTML::iframe -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-img-element-1">
        <h5 id="the-img-element" aria-level="4" role="heading"><span class="secno">3.5.5.4 </span>The <code>img</code> element</h5>

        <p>When fetching an image via step 12 of the <a href="http://www.w3.org/TR/html5/embedded-content-0.html#update-the-image-data">update the image data</a>
algorithm:</p>

        <ol>
          <li>Set the <a href="#dfn-integrity-metadata">integrity metadata</a> of the request to the value
of the element’s <code>integrity</code> attribute.</li>
        </ol>

        <p>Before jumping one of the entries from the list in step 14 of the
<a href="http://www.w3.org/TR/html5/embedded-content-0.html#update-the-image-data">update the image data</a> algorithm, first perform the following
steps:</p>

        <ol>
          <li>If the response’s integrity state is <code>corrupt</code>:
            <ol>
              <li>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>:
                <ol>
                  <li>Abort the jump in progress.</li>
                  <li>Perform the steps in the entry labeled “Otherwise” under step 14.</li>
                </ol>
              </li>
              <li><a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">Report a violation</a>.</li>
            </ol>
          </li>
        </ol>

      </section>
      <!-- /Framework::HTML::Elements::img -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-link-element-1">
        <h5 id="the-link-element" aria-level="4" role="heading"><span class="secno">3.5.5.5 </span>The <code>link</code> element</h5>

        <p>Whenever a user agent attempts to <a href="http://www.w3.org/TR/html5/document-metadata.html#concept-link-obtain">obtain a resource</a> pointed to by a
<code>link</code> element:</p>

        <ol>
          <li>Set the <a href="#dfn-integrity-metadata">integrity metadata</a> of the request to the value
of the element’s <code>integrity</code> attribute.</li>
        </ol>

        <p>Additionally, perform the following steps before firing a <code>load</code> event at
the element:</p>

        <ol>
          <li>If the response’s integrity state is <code>corrupt</code>:
            <ol>
              <li>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>:
                <ol>
                  <li>Abort the <code>load</code> event, and treat the resource as having failed
to load.</li>
                  <li>If <var>resource</var> is <a href="http://tools.ietf.org/html/rfc6454#section-5">same origin</a> with the origin of
the <code>link</code> element’s Document, then <a href="http://www.w3.org/TR/html5/webappapis.html#queue-a-task">queue a task</a> to
<a href="http://www.w3.org/TR/html5/webappapis.html#fire-a-simple-event">fire a simple event</a> named <code>error</code> at the <code>link</code> element.</li>
                </ol>
              </li>
              <li><a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">Report a violation</a>.</li>
            </ol>
          </li>
        </ol>

      </section>
      <!-- /Framework::HTML::link -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-object-element-1">
        <h5 id="the-object-element" aria-level="4" role="heading"><span class="secno">3.5.5.6 </span>The <code>object</code> element</h5>

        <p>When fetching an image via step 4 of step 4 of the <a href="http://www.w3.org/TR/html5/embedded-content-0.html#update-the-image-data">“determine what the
<code>object</code> element represents” algorithm</a>:</p>

        <ol>
          <li>Set the <a href="#dfn-integrity-metadata">integrity metadata</a> of the request to the value
of the element’s <code>integrity</code> attribute.</li>
        </ol>

        <p>Before step 7 of the <a href="http://www.w3.org/TR/html5/embedded-content-0.html#update-the-image-data">“determine what the <code>object</code> element represents”
algorithm</a>, first perform the following steps:</p>

        <ol>
          <li>If the response’s integrity state is <code>corrupt</code>:
            <ol>
              <li>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>:
                <ol>
                  <li><a href="http://www.w3.org/TR/html5/webappapis.html#fire-a-simple-event">Fire a simple event</a> named <code>error</code> at the element.</li>
                  <li>Jump to the step labeled <i>fallback</i>.</li>
                </ol>
              </li>
              <li><a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">Report a violation</a>.</li>
            </ol>
          </li>
        </ol>

      </section>
      <!-- /Framework::HTML::Elements::object -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-script-element-1">
        <h5 id="the-script-element" aria-level="4" role="heading"><span class="secno">3.5.5.7 </span>The <code>script</code> element</h5>

        <p>When executing step 5 of step 14 of HTML5’s
<a href="http://www.w3.org/TR/html5/scripting-1.html#prepare-a-script">“prepare a script” algorithm</a>:</p>

        <ol>
          <li>Set the <a href="#dfn-integrity-metadata">integrity metadata</a> of the request to the value
of the element’s <code>integrity</code> attribute.</li>
        </ol>

        <p>Insert the following steps after step 5 of step 14 of HTML5’s
<a href="http://www.w3.org/TR/html5/scripting-1.html#prepare-a-script">“prepare a script” algorithm</a>:</p>

        <ol start="6">
          <li>Once the <a href="http://www.w3.org/TR/html5/infrastructure.html#fetch">fetching algorithm</a> has completed:
            <ol>
              <li>If the response’s integrity state is <code>corrupt</code>:
                <ol>
                  <li>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>:
                    <ol>
                      <li>If <var>resource</var> is <a href="http://tools.ietf.org/html/rfc6454#section-5">same origin</a> with the <code>link</code>
element’s Document’s origin, then <a href="http://www.w3.org/TR/html5/webappapis.html#queue-a-task">queue a task</a> to
<a href="http://www.w3.org/TR/html5/webappapis.html#fire-a-simple-event">fire a simple event</a> named <code>error</code> at the element, and
abort these steps.</li>
                    </ol>
                  </li>
                  <li><a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">Report a violation</a>.</li>
                </ol>
              </li>
            </ol>
          </li>
        </ol>

      </section>
      <!-- /Framework::HTML::Elements::script -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-track-element-1">
        <h5 id="the-track-element" aria-level="4" role="heading"><span class="secno">3.5.5.8 </span>The <code>track</code> element</h5>

        <p>When fetching the <a href="http://www.w3.org/TR/html5/embedded-content-0.html#track-url">track URL</a> in step 10 of the <a href="http://www.w3.org/TR/html5/embedded-content-0.html#start-the-track-processing-model">start the <code>track</code>
processing model</a> algorithm:</p>

        <ol>
          <li>Set the <a href="#dfn-integrity-metadata">integrity metadata</a> of the request to the value
of the element’s <code>integrity</code> attribute.</li>
        </ol>

        <p>Additionally, perform the following steps before performing the steps
specified for a successful <code>track</code> fetch:</p>

        <ol>
          <li>If the response’s integrity state is <code>corrupt</code>:
            <ol>
              <li>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>:
                <ol>
                  <li>Perform the steps specified for a failed <code>track</code> fetch.</li>
                  <li>Abort the steps specified for a successful <code>track</code> fetch.</li>
                </ol>
              </li>
              <li><a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">Report a violation</a>.</li>
            </ol>
          </li>
        </ol>

      </section>
      <!-- /Framework::HTML::Elements::track -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-audio-element-todo-1">
        <h5 id="the-audio-element-todo" aria-level="4" role="heading"><span class="secno">3.5.5.9 </span>The <code>audio</code> element (TODO)</h5>

        <div class="issue"><div class="issue-title" aria-level="5" role="heading" id="h_issue_10"><span>Issue 10</span></div><p class="">TODO: Write this section? Might want to delay media elements until we have a solution to streaming.</p></div>
      </section>
      <!-- /Framework::HTML::Elements::audio -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-source-element-todo-1">
        <h5 id="the-source-element-todo" aria-level="4" role="heading"><span class="secno">3.5.5.10 </span>The <code>source</code> element (TODO)</h5>

        <div class="issue"><div class="issue-title" aria-level="5" role="heading" id="h_issue_11"><span>Issue 11</span></div><p class="">TODO: Write this section? Might want to delay media elements until we have a solution to streaming.</p></div>
      </section>
      <!-- /Framework::HTML::Elements::source -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-video-element-todo-1">
        <h5 id="the-video-element-todo" aria-level="4" role="heading"><span class="secno">3.5.5.11 </span>The <code>video</code> element (TODO)</h5>

        <div class="issue"><div class="issue-title" aria-level="5" role="heading" id="h_issue_12"><span>Issue 12</span></div><p class="">TODO: Write this section? Might want to delay media elements until we have a solution to streaming.</p></div>
      </section>
      <!-- /Framework::HTML::Elements::video -->

    </section>
    <!-- /Framework::HTML::Elements -->

  </section>
  <!-- /Framework::HTML -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="verification-of-css-loaded-subresources-1">
    <h3 id="verification-of-css-loaded-subresources" aria-level="2" role="heading"><span class="secno">3.6 </span>Verification of CSS-loaded subresources</h3>

    <div class="issue"><div class="issue-title" aria-level="3" role="heading" id="h_issue_13"><span>Issue 13</span></div><p class="">Tab and Anne are poking at adding <code>fetch()</code> to some spec somewhere
which would allow CSS files to specify various arguments to the fetch
algorithm while requesting resources. Detail on the proposal is at
<a href="http://lists.w3.org/Archives/Public/public-webappsec/2014Jan/0129.html">http://lists.w3.org/Archives/Public/public-webappsec/2014Jan/0129.html</a>.
Once that is specified, we can proceed defining an <code>integrity</code> argument
that would allow integrity checks in CSS.</p></div>

  </section>
  <!-- /Framework::CSS -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="verification-of-js-loaded-subresources-1">
    <h3 id="verification-of-js-loaded-subresources" aria-level="2" role="heading"><span class="secno">3.7 </span>Verification of JS-loaded subresources</h3>

    <div class="issue"><div class="issue-title" aria-level="3" role="heading" id="h_issue_14"><span>Issue 14</span></div><p class="">These sections are less fleshed out and debated than the HTML sections, where
the WG has concentrated most of its time thus far.</p></div>

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="workers-1">
      <h4 id="workers" aria-level="3" role="heading"><span class="secno">3.7.1 </span>Workers</h4>

      <p>To validate the integrity of scripts which are to be run as workers, a new
constructor is added for <code>Worker</code> and <code>SharedWorker</code> which accepts a second
argument containing integrity metadata. This information is used when
<a href="http://dev.w3.org/html5/workers/#run-a-worker">running a worker</a> to perform validation, as outlined in the
following sections: [<cite><a class="bibref" href="#bib-WEBWORKERS">WEBWORKERS</a></cite>]</p>

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="worker-extension-1">
        <h5 id="worker-extension" aria-level="4" role="heading"><span class="secno">3.7.1.1 </span>Worker extension</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-Worker">[<span class="extAttr">Constructor (DOMString scriptURL, DOMString integrityMetadata)</span>]
partial interface <span class="idlInterfaceID">Worker</span> : <span class="idlSuperclass">EventTarget</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-Worker-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-9"><h6 aria-level="5" role="heading" id="h6_attributes-9"><span class="secno">3.7.1.1.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-Worker-integrity"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of the Worker’s <code>integrity</code> attribute. Defaults to the empty string.</dd></dl></section>

        <p>When the <code>Worker(scriptURL, integrityMetadata)</code> constructor is invoked:</p>

        <ol>
          <li>If <code>integrityMetadata</code> is not a valid “named information” (<code>ni</code>) URL,
throw a <code>SyntaxError</code> exception and abort these steps.</li>
          <li>Execute the <code>Worker(scriptURL)</code> constructor, and set the newly created
<code>Worker</code> object’s <code>integrity</code> attribute to <code>integrityMetadata</code>.</li>
        </ol>
      </section>
      <!-- /Framework::JS::Workers::Worker -->
      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="sharedworker-extension-1">
        <h5 id="sharedworker-extension" aria-level="4" role="heading"><span class="secno">3.7.1.2 </span>SharedWorker extension</h5>

        <pre class="idl"><span class="idlInterface" id="idl-def-Worker-1">[<span class="extAttr">Constructor (DOMString scriptURL, DOMString name, DOMString integrityMetadata)</span>]
partial interface <span class="idlInterfaceID">Worker</span> : <span class="idlSuperclass">EventTarget</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-Worker-integrity">integrity</a></span>;</span>
};</span></pre><section id="attributes-10"><h6 aria-level="5" role="heading" id="h6_attributes-10"><span class="secno">3.7.1.2.1 </span>Attributes</h6><dl class="attributes"><dt id="widl-Worker-integrity-1"><code>integrity</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>The value of the SharedWorker’s <code>integrity</code> attribute. Defaults to the empty string.</dd></dl></section>

        <p>When the <code>SharedWorker(scriptURL, name, integrityMetadata)</code> constructor is
invoked:</p>

        <ol>
          <li>If <code>integrityMetadata</code> is not a valid “named information” (<code>ni</code>) URL,
throw a <code>SyntaxError</code> exception and abort these steps.</li>
          <li>Execute the <code>SharedWorker(scriptURL, name)</code> constructor, and set the
newly created <code>SharedWorker</code> object’s <code>integrity</code> attribute to
<code>integrityMetadata</code>.</li>
        </ol>
      </section>
      <!-- /Framework::JS::Workers::SharedWorker -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="validation-2">
        <h5 id="validation" aria-level="4" role="heading"><span class="secno">3.7.1.3 </span>Validation</h5>

        <p>Add the following step directly after step 4 of the <a href="http://dev.w3.org/html5/workers/#run-a-worker">run a worker</a>
algorithm:</p>

        <ol start="5">
          <li>If the script resource fetched in step 4 has an integrity status of
<code>corrupt</code>, then for each <code>Worker</code> or <code>SharedWorker</code> object associated
with <var>worker global scope</var>, <a href="http://www.w3.org/TR/html5/webappapis.html#queue-a-task">queue a task</a> to <a href="http://www.w3.org/TR/html5/webappapis.html#fire-a-simple-event">fire a
simple event</a> named <code>error</code> at that object. Abort these steps.</li>
        </ol>
      </section>
      <!-- /Framework::JS::Workers::validation -->

    </section>
    <!-- /Framework::JS::Workers -->

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="xmlhttprequest-1">
      <h4 id="xmlhttprequest" aria-level="3" role="heading"><span class="secno">3.7.2 </span>XMLHttpRequest</h4>

      <p>To validate the integrity of resources loaded via <code>XMLHttpRequest</code>, a new
<code>integrity</code> attribute is added to the <code>XMLHttpRequest</code> object. If set, the
<a href="#dfn-integrity-metadata">integrity metadata</a> in this attribute is used to validate the resource
before triggering the <code>load</code> event. [<cite><a class="bibref" href="#bib-XMLHTTPREQUEST">XMLHTTPREQUEST</a></cite>]</p>

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="the-integrity-attribute-3">
        <h5 id="the-integrity-attribute-1" aria-level="4" role="heading"><span class="secno">3.7.2.1 </span>The <code>integrity</code> attribute</h5>

        <p>The <code>integrity</code> attribute must return its value. Initially its value <em class="rfc2119" title="MUST">MUST</em>
be the empty string.</p>

        <p>Setting the <code>integrity</code> attribute <em class="rfc2119" title="MUST">MUST</em> run these steps:</p>

        <ol>
          <li>If the state is not <code>UNSENT</code> or <code>OPENED</code>, throw an <code>InvalidStateError</code>
exception and abort these steps.</li>
          <li>If the value provided is not a valid “named information” (<code>ni</code>) URL,
throw a “SyntaxError` exception and abort these steps.</li>
          <li>Set the <code>integrity</code> attribute’s value to the value provided.</li>
        </ol>

      </section>
      <!-- /Framework::JS::XHR::integrity -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="progress-events-1">
        <h5 id="progress-events" aria-level="4" role="heading"><span class="secno">3.7.2.2 </span>Progress events</h5>

        <p>Validation only takes place when the entire resource body has been
downloaded. Data processed before the resource has completely
loaded (or failed to load) is unvalidated, and potentially corrupt.
For that reason, if the document’s <a href="#dfn-integrity-policy">integrity policy</a>
is <code>block</code>, progress events will not fire until the fetch has
completed, one way or another.</p>

        <p>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is not <code>block</code>, developers who
care about integrity validation <em class="rfc2119" title="SHOULD">SHOULD</em> still ignore progress events
fired while the resource is downloading, and instead listen only for
the <code>load</code>, <code>abort</code>, and <code>error</code> events.</p>

        <p>If the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>, then:</p>

        <ul>
          <li>Before executing step 3.2 of the “process response” algorithm in
step 13 of XMLHttpRequest’s <a href="http://xhr.spec.whatwg.org/#dom-xmlhttprequest-send"><code>send(data)</code></a> method:
            <ol>
              <li>If the object’s <code>integrity</code> attribute is not the empty string
the user agent <em class="rfc2119" title="MUST">MUST</em> abort the “process response” algorithm, and
<em class="rfc2119" title="MUST NOT">MUST NOT</em> fire the <code>readystatechange</code> event.</li>
            </ol>
          </li>
          <li>Before executing step 2.2 of the “process response body” algorithm in
step 13 of XMLHttpRequest’s <a href="http://xhr.spec.whatwg.org/#dom-xmlhttprequest-send"><code>send(data)</code></a> method:
            <ol>
              <li>If the object’s <code>integrity</code> attribute is not the empty string
the user agent <em class="rfc2119" title="MUST">MUST</em> abort the “process response body” algorithm,
and <em class="rfc2119" title="MUST NOT">MUST NOT</em> fire the <code>readystatechange</code> event.</li>
            </ol>
          </li>
          <li>Before executing step 4 of the “process response body” algorithm in
step 13 of XMLHttpRequest’s <a href="http://xhr.spec.whatwg.org/#dom-xmlhttprequest-send"><code>send(data)</code></a> method:
            <ol>
              <li>If the object’s <code>integrity</code> attribute is not the empty string
the user agent <em class="rfc2119" title="MUST">MUST</em> abort the “process response body” algorithm,
and <em class="rfc2119" title="MUST NOT">MUST NOT</em> fire the <code>progress</code> event.</li>
            </ol>
          </li>
        </ul>

      </section>
      <!-- /Framework::JS::XHR::integrity -->

      <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="validation-3">
        <h5 id="validation-1" aria-level="4" role="heading"><span class="secno">3.7.2.3 </span>Validation</h5>

        <p>Whenever the user agent would <a href="https://dvcs.w3.org/hg/xhr/raw-file/tip/Overview.html#switch-done">switch an <code>XMLHttpRequest</code> object to the
<code>DONE</code> state</a>, then perform the following steps before
switching state:</p>

        <ol>
          <li>If the response’s integrity state is <code>intact</code> or <code>indeterminate</code>,
then abort these steps, and continue to
<a href="https://dvcs.w3.org/hg/xhr/raw-file/tip/Overview.html#switch-done">switch to the <code>DONE</code> state</a>.</li>
          <li>Otherwise, <a href="http://www.w3.org/TR/CSP11/#dfn-report-a-violation">report a violation</a>, and run the following steps
if the document’s <a href="#dfn-integrity-policy">integrity policy</a> is <code>block</code>:
            <ol>
              <li>Set the <a href="https://dvcs.w3.org/hg/xhr/raw-file/tip/Overview.html#response-entity-body">response entity body</a> to <code>null</code></li>
              <li>Run the <a href="http://www.w3.org/TR/XMLHttpRequest/#request-error">request error</a> steps for exception
<a href="http://dev.w3.org/2006/webapi/DOM4Core/#networkerror"><code>NetworkError</code></a> and event <a href="http://www.w3.org/TR/XMLHttpRequest/#event-xhr-error"><code>error</code></a>.</li>
              <li>Do not continue to <a href="https://dvcs.w3.org/hg/xhr/raw-file/tip/Overview.html#switch-done">switch to the <code>DONE</code> state</a>.</li>
            </ol>
          </li>
        </ol>

      </section>
      <!-- Framework::JS::XHR::validation -->

    </section>
    <!-- /Framework::JS::XHR -->

  </section>
  <!-- /Framework::JS -->
</section>
<!-- /Framework -->

<section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="caching-optional-1">
  <!--OddPage--><h2 id="caching-optional" aria-level="1" role="heading"><span class="secno">4. </span>Caching (Optional)</h2>

  <p>The caching mechanism described in this section is <em class="rfc2119" title="OPTIONAL">OPTIONAL</em>.</p>

  <p>JavaScript libraries are a good example of resources that are often loaded
and reloaded from different locations as users browse the web:
<code>http://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js</code> is
exactly the same file as
<code>https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js</code>. Both
files are identifiable via the <code>ni</code> URL
<code>ni:///sha-256;iaFenEC8axSAnyNu6M0-0epCOTwfbKVceFXNd5s_ki4?ct=application/javascript</code>.</p>

  <p>To reduce the performance impact of reloading the same data, user agents
<em class="rfc2119" title="MAY">MAY</em> use <a href="#dfn-integrity-metadata">integrity metadata</a> as a new index to a local cache, meaning that
a user who had already loaded a version of the file from <code>ajax.googleapis.com</code>
wouldn’t have to touch the network to load the <code>cdnjs.cloudflare.com</code> version.
The user agent knows that the content is the same, and would be free to treat
the latter as a cache hit, regardless of the location mismatch.</p>

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="risks-1">
    <h3 id="risks" aria-level="2" role="heading"><span class="secno">4.1 </span>Risks</h3>

    <p>This approach is good for performance, but can have security implications. See
the <a href="#origin-confusion">origin confusion</a> and <a href="#mime-type-confusion">MIME type confusion</a> sections below for some
details.</p>

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="origin-confusion-1">
      <h4 id="origin-confusion" aria-level="3" role="heading"><span class="secno">4.1.1 </span>Origin confusion</h4>

      <p>User agents which set up a caching mechanism that uses only the integrity
metadata to identify a resource are vulnerable to attacks which bypass
same-origin restrictions unless they are very careful when choosing whether
or not to read data straight from the cache.</p>

      <p>For instance:</p>

      <ul>
        <li>
          <p><a href="http://www.w3.org/TR/html5/webappapis.html#runtime-script-errors">Runtime script errors</a> are sanitized for resources that are
<a href="http://www.w3.org/TR/html5/infrastructure.html#cors-cross-origin">CORS-cross-origin</a> to the page into which they are loaded. [<cite><a class="bibref" href="#bib-HTML5">HTML5</a></cite>]</p>
        </li>
        <li>
          <p>XMLHttpRequest may only load data from same-origin resources, or from
resources delivered with proper CORS headers. [<cite><a class="bibref" href="#bib-XMLHTTPREQUEST">XMLHTTPREQUEST</a></cite>]</p>
        </li>
        <li>
          <p>Content Security Policy performs origin-based security checks. [<cite><a class="bibref" href="#bib-CSP">CSP</a></cite>]</p>
        </li>
      </ul>

      <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_15"><span>Issue 15</span></div><p class="">More?</p></div>

      <div class="note"><div class="note-title" aria-level="4" role="heading" id="h_note_5"><span>Note</span></div><div class="">
        <p>The simple cache-poisoning version of this attack can be mitigated by
requiring strong hash functions for cachable resources. More complex
variants are more difficult to mitigate. Consider the following:</p>

        <ol>
          <li>
            <p>An attacker lures Alice to a page containing the following code:</p>

            <pre><code>&lt;script src="http://evil.com/evil.js" digest="ni://sha-256;123...789"&gt;
</code></pre>
          </li>
          <li>
            <p>Alice’s user agent loads <code>evil.js</code>, and stores it in her cache.</p>
          </li>
          <li>
            <p>Though <code>bank.com</code> is protected by a CSP which allows only script from
<code>bank.com</code>, the attacker may still be able to exploit an XSS vulnerability
in <code>bank.com</code> which allows the injection of:</p>

            <pre><code>&lt;script src="http://bank.com/awesome.js" digest="ni://sha-256;123...789"&gt;
</code></pre>

            <p>Since the script appears to come from <code>bank.com</code>, CSP allows it, even though
it doesn’t actually exist on that server.</p>
          </li>
        </ol>
      </div></div>

    </section>
    <!-- /Caching::Risks::Origin confusion -->

    <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="mime-type-confusion-1">
      <h4 id="mime-type-confusion" aria-level="3" role="heading"><span class="secno">4.1.2 </span>MIME type confusion</h4>

      <p>User agents which set up a caching mechanism that uses only the integrity
metadata to identify a resource are vulnerable to attacks which create
resources that behave differently based on the context in which they are
loaded. <a href="http://en.wikipedia.org/wiki/Gifar">Gifar</a> is the canonical example of such an attack.</p>

      <p>Authors <em class="rfc2119" title="SHOULD">SHOULD</em> mitigate this risk by specifying the expected content type
along with the digest, as specified in <a href="http://tools.ietf.org/html/rfc6920#section-3.1">RFC 6920, section 3.1</a>.
This means that the content type will be verified along with the digest when
determining whether a <a href="#does-resource-match-metadata">resource matches certain integrity
metadata</a>.</p>

    </section>
    <!-- /Caching::Risks::MIME Type confusion -->
  </section>
  <!-- /Caching::Risks -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="recommendations-1">
    <h3 id="recommendations" aria-level="2" role="heading"><span class="secno">4.2 </span>Recommendations</h3>

    <p>To mitigate the risk of cross-origin data leakage or type-sniffing
exploitation, user agents that take this approach to caching <em class="rfc2119" title="MUST NOT">MUST NOT</em>
use <a href="#dfn-integrity-metadata">integrity metadata</a> as a cache identifier unless the following
are all true:</p>

    <ul>
      <li>The integrity metadata contains a content type.</li>
      <li>The resource was delivered in response to an HTTP <code>GET</code> request (and not
<code>POST</code>, <code>OPTIONS</code>, <code>TRACE</code>, etc.)</li>
      <li>The resource was delivered with an <code>Access-Control-Allow-Origin</code> HTTP
header with a value of <code>*</code> [<cite><a class="bibref" href="#bib-CORS">CORS</a></cite>]</li>
      <li>The integrity metadata uses a hash function with very strong uniqueness
characteristics: SHA-512 or better.</li>
      <li>If a Content Security Policy is active in a context, the <code>script</code> or
<code>link</code> element which triggered the resource’s fetch has a <a href="http://w3c.github.io/webappsec/specs/content-security-policy/csp-specification.dev.html#valid-nonces">valid nonce</a>.</li>
    </ul>

    <div class="issue"><div class="issue-title" aria-level="3" role="heading" id="h_issue_16"><span>Issue 16</span></div><p class="">More ideas? Limiting to resources with wide-open CORS headers and strong
hash functions seems like a reasonable start…</p></div>
  </section>
  <!-- /Caching::Recommendations -->
</section>
<!-- /Caching -->

<section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="proxies-1">
  <!--OddPage--><h2 id="proxies" aria-level="1" role="heading"><span class="secno">5. </span>Proxies</h2>

  <p>Optimizing proxies and other intermediate servers which modify the
content of fetched resources <em class="rfc2119" title="MUST">MUST</em> ensure that the digest associated
with those resources stays in sync with the new content. One option
is to ensure that the <a href="#dfn-integrity-metadata">integrity metadata</a> associated with
resources is updated along with the resource itself. Another
would be simply to deliver only the canonical version of resources
for which a page author has requested integrity verification. To
support this latter option, user agents <em class="rfc2119" title="MAY">MAY</em> send a
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9"><code>Cache-Control</code></a> header with a value of
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9.5"><code>no-transform</code></a>.</p>

  <div class="issue"><div class="issue-title" aria-level="2" role="heading" id="h_issue_17"><span>Issue 17</span></div><p class="">Think about how integrity checks would effect <code>vary</code> headers
in general.</p></div>

</section>
<!-- /Implementation -->

<section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="security-considerations-1">
  <!--OddPage--><h2 id="security-considerations" aria-level="1" role="heading"><span class="secno">6. </span>Security Considerations</h2>

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="insecure-channels-remain-insecure-1">
    <h3 id="insecure-channels-remain-insecure" aria-level="2" role="heading"><span class="secno">6.1 </span>Insecure channels remain insecure</h3>

    <p><a href="#dfn-integrity-metadata">Integrity metadata</a> delivered over an insecure channel provides no security
benefit. Attackers can alter the digest in-flight (or remove it entirely (or
do absolutely anything else to the document)), just as they could alter the
resource the hash is meant to validate. Authors who desire any sort of
security whatsoever <em class="rfc2119" title="SHOULD">SHOULD</em> deliver resources containing digests over
secure channels.</p>
  </section>
  <!-- /Security::Insecure channels -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="hash-collision-attacks-1">
    <h3 id="hash-collision-attacks" aria-level="2" role="heading"><span class="secno">6.2 </span>Hash collision attacks</h3>

    <p>Digests are only as strong as the hash function used to generate them. User
agents <em class="rfc2119" title="SHOULD">SHOULD</em> refuse to support known-weak hashing functions like MD5, and
<em class="rfc2119" title="SHOULD">SHOULD</em> restrict supported hashing functions to those known to be
collision-resistant. At the time of writing, SHA-256 is a good baseline.
Moreover, user agents <em class="rfc2119" title="SHOULD">SHOULD</em> reevaluate their supported hashing functions
on a regular basis, and deprecate support for those functions shown to be
insecure.</p>
  </section>
  <!-- /Security::Hash collision -->

  <section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="cross-origin-data-leakage-1">
    <h3 id="cross-origin-data-leakage" aria-level="2" role="heading"><span class="secno">6.3 </span>Cross-origin data leakage</h3>

    <p>Attackers can determine whether some cross-origin resource has certain
content by attempting to load it with a known digest, and watching for
load failure. If the load fails, the attacker can surmise that the
resource didn’t match the hash, and thereby gain some insight into its
contents. This might reveal, for example, whether or not a user is
logged into a particular service.</p>

    <p>Moreover, attackers can brute-force specific values in an otherwise
static resource: consider a document that looks like this:</p>

    <pre><code>&lt;html&gt;{static content}&lt;h1&gt;Hello, $username!&lt;/h1&gt;{static content}&lt;/html&gt;
</code></pre>

    <p>An attacker can precompute hashes for the page with a variety of
common usernames, and specify those hashes while repeatedly attempting
to load the document. By examining the reported violations, the attacker
can obtain a user’s username.</p>

    <p>User agents <em class="rfc2119" title="SHOULD">SHOULD</em> mitigate the risk by refusing to fire <code>error</code> events
on elements which loaded cross-origin resources, but some side-channels
will likely be difficult to avoid (image’s <code>naturalHeight</code> and
<code>naturalWidth</code> for instance).</p>
  </section>
  <!-- /Security::cross-origin -->

</section>
<!-- /Security -->

<section typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter" id="acknowledgements-1">
  <!--OddPage--><h2 id="acknowledgements" aria-level="1" role="heading"><span class="secno">7. </span>Acknowledgements</h2>

  <p>None of this is new. Much of the content here is inspired heavily by Gervase
Markham’s <a href="http://www.gerv.net/security/link-fingerprints/">Link Fingerprints</a> concept, as well as WHATWG’s <a href="http://wiki.whatwg.org/wiki/Link_Hashes">Link Hashes</a>.</p>

</section>



<section id="references" class="appendix" typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter"><!--OddPage--><h2 aria-level="1" role="heading" id="h2_references"><span class="secno">A. </span>References</h2><section id="normative-references" typeof="bibo:Chapter" resource="#ref" rel="bibo:Chapter"><h3 aria-level="2" role="heading" id="h3_normative-references"><span class="secno">A.1 </span>Normative references</h3><dl class="bibliography" about=""><dt id="bib-ABNF">[ABNF]</dt><dd rel="dcterms:requires">D. Crocker; P. Overell. <a href="http://www.ietf.org/rfc/rfc5234.txt"><cite>Augmented BNF for Syntax Specifications: ABNF</cite></a>. January 2008. STD. URL: <a href="http://www.ietf.org/rfc/rfc5234.txt">http://www.ietf.org/rfc/rfc5234.txt</a>
</dd><dt id="bib-CORS">[CORS]</dt><dd rel="dcterms:requires">Anne van Kesteren. <a href="http://www.w3.org/TR/cors/"><cite>Cross-Origin Resource Sharing</cite></a>. 16 January 2014. W3C Recommendation. URL: <a href="http://www.w3.org/TR/cors/">http://www.w3.org/TR/cors/</a>
</dd><dt id="bib-CSP">[CSP]</dt><dd rel="dcterms:requires">Adam Barth; Dan Veditz; Mike West. <a href="http://w3.org/TR/CSP11"><cite>Content Security Policy 1.1</cite></a>. Working Draft. URL: <a href="http://w3.org/TR/CSP11">http://w3.org/TR/CSP11</a>
</dd><dt id="bib-HTML5">[HTML5]</dt><dd rel="dcterms:requires">Robin Berjon; Steve Faulkner; Travis Leithead; Erika Doyle Navara; Edward O'Connor; Silvia Pfeiffer. <a href="http://www.w3.org/TR/html5/"><cite>HTML5</cite></a>. 4 February 2014. W3C Candidate Recommendation. URL: <a href="http://www.w3.org/TR/html5/">http://www.w3.org/TR/html5/</a>
</dd><dt id="bib-HTTP11">[HTTP11]</dt><dd rel="dcterms:requires">R. Fielding et al. <a href="http://www.ietf.org/rfc/rfc2616.txt"><cite>Hypertext Transfer Protocol - HTTP/1.1</cite></a>. June 1999. RFC. URL: <a href="http://www.ietf.org/rfc/rfc2616.txt">http://www.ietf.org/rfc/rfc2616.txt</a>
</dd><dt id="bib-MIMETYPE">[MIMETYPE]</dt><dd rel="dcterms:requires">Ned Freed; Nathaniel S. Borenstein. <a href="http://tools.ietf.org/html/rfc2046"><cite>Multipurpose Internet Mail Extensions (MIME) Part Two: Media Types</cite></a>. Draft Standard. URL: <a href="http://tools.ietf.org/html/rfc2046">http://tools.ietf.org/html/rfc2046</a>
</dd><dt id="bib-RFC2119">[RFC2119]</dt><dd rel="dcterms:requires">S. Bradner. <a href="http://www.ietf.org/rfc/rfc2119.txt"><cite>Key words for use in RFCs to Indicate Requirement Levels.</cite></a> March 1997. Internet RFC 2119.  URL: <a href="http://www.ietf.org/rfc/rfc2119.txt">http://www.ietf.org/rfc/rfc2119.txt</a> 
</dd><dt id="bib-RFC2818">[RFC2818]</dt><dd rel="dcterms:requires">E. Rescorla. <a href="http://www.ietf.org/rfc/rfc2818.txt"><cite>HTTP Over TLS</cite></a>. May 2000. RFC. URL: <a href="http://www.ietf.org/rfc/rfc2818.txt">http://www.ietf.org/rfc/rfc2818.txt</a>
</dd><dt id="bib-RFC4648">[RFC4648]</dt><dd rel="dcterms:requires">Simon Josefsson. <a href="http://tools.ietf.org/html/rfc4648"><cite>The Base16, Base32, and Base64 Data Encodings</cite></a>. Proposed Standard. URL: <a href="http://tools.ietf.org/html/rfc4648">http://tools.ietf.org/html/rfc4648</a>
</dd><dt id="bib-RFC6454">[RFC6454]</dt><dd rel="dcterms:requires">A. Barth. <a href="http://www.ietf.org/rfc/rfc6454.txt"><cite>The Web Origin Concept</cite></a>. December 2011. RFC. URL: <a href="http://www.ietf.org/rfc/rfc6454.txt">http://www.ietf.org/rfc/rfc6454.txt</a>
</dd><dt id="bib-RFC6920">[RFC6920]</dt><dd rel="dcterms:requires">Stephen Farrell; Dirk Kutscher; Christian Dannewitz; Borje Ohlman; Ari Keranen; Phillip Hallam-Baker. <a href="http://tools.ietf.org/html/rfc6920"><cite>Naming Things with Hashes</cite></a>. Proposed Standard. URL: <a href="http://tools.ietf.org/html/rfc6920">http://tools.ietf.org/html/rfc6920</a>
</dd><dt id="bib-WEBWORKERS">[WEBWORKERS]</dt><dd rel="dcterms:requires">Ian Hickson. <a href="http://www.w3.org/TR/workers/"><cite>Web Workers</cite></a>. 1 May 2012. W3C Candidate Recommendation. URL: <a href="http://www.w3.org/TR/workers/">http://www.w3.org/TR/workers/</a>
</dd><dt id="bib-XMLHTTPREQUEST">[XMLHTTPREQUEST]</dt><dd rel="dcterms:requires">Anne van Kesteren; Julian Aubourg; Jungkee Song; Hallvord Steen et al. <a href="http://www.w3.org/TR/XMLHttpRequest/"><cite>XMLHttpRequest Level 1</cite></a>. 30 January 2014. W3C Working Draft. URL: <a href="http://www.w3.org/TR/XMLHttpRequest/">http://www.w3.org/TR/XMLHttpRequest/</a>
</dd></dl></section></section></body></html>
